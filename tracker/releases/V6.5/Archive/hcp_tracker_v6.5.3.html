<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCP Portfolio Tracker v6.5.3 - Portfolio Optimization</title>
    <!--
    HCP PORTFOLIO TRACKER v6.5.3 - STEP 5 PORTFOLIO OPTIMIZATION ADDED
    File: hcp_tracker_v6.5.3_portfolio_optimization.html
    Last Updated: 2025-09-02 19:15:00 UTC
    
    NEW IN v6.5.3:
    - Added Step 5: Portfolio Optimization module
    - PortfolioOptimizer v1.0 with mean-variance optimization
    - Probability-weighted allocation across 16 scenarios
    - Theme-based asset tilting per IPS v3.10 specifications
    - Risk constraints and bounds for practical implementation
    - Asset allocation recommendations display
    
    FOUNDATION (Preserved from v6.5.2):
    - Steps 1-4 fully functional
    - TrackerCore v1.0 architecture
    - DataEditor modal system
    - ThemeCalculator v2.9 with 16-scenario matrix
    - Single-file deployment maintained
    -->
    <style>
        /* Base styles - Same as v6.5.2 */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container {
            background: white; border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px; margin: 0 auto; overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center;
        }
        .progress-bar {
            background: rgba(255,255,255,0.2); padding: 20px;
            display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;
        }
        .step-indicator {
            flex: 1; min-width: 80px; text-align: center; cursor: pointer;
            padding: 10px; border-radius: 8px; transition: all 0.3s;
        }
        .step-indicator.completed { background: rgba(255,255,255,0.3); }
        .step-indicator.active { background: #ffc107; color: #333; }
        .step-indicator.locked { opacity: 0.5; cursor: not-allowed; }
        .navigation {
            background: #f8f9fa; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #dee2e6;
        }
        .nav-button {
            background: #667eea; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-size: 16px; transition: background 0.3s;
        }
        .nav-button:hover:not(:disabled) { background: #5a67d8; }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .content { padding: 30px; min-height: 400px; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        
        /* Status and theme styles */
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .theme-analysis-v651 { max-width: 1000px; margin: 0 auto; }
        .theme-item { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .theme-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .theme-name { font-size: 1.2em; font-weight: bold; color: #333; }
        .theme-percentage { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .theme-bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
        .theme-fill { height: 100%; transition: width 0.5s ease; }

        /* Scenario matrix styles */
        .scenario-matrix { max-width: 1200px; margin: 0 auto; }
        .scenario-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .scenario-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .scenario-card:hover { transform: translateY(-2px); }
        .scenario-rank { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .scenario-name { font-weight: bold; font-size: 1.1em; margin-bottom: 8px; color: #333; }
        .scenario-probability { font-size: 1.3em; font-weight: bold; margin-bottom: 8px; }
        .scenario-binary { font-family: monospace; font-size: 0.8em; color: #666; margin-bottom: 5px; }
        .scenario-themes { font-size: 0.9em; color: #555; }
        
        /* Color coding for probability ranges */
        .prob-very-high { color: #dc3545; background: #f8d7da; border-left: 4px solid #dc3545; }
        .prob-high { color: #fd7e14; background: #ffeaa7; border-left: 4px solid #fd7e14; }
        .prob-medium { color: #28a745; background: #d4edda; border-left: 4px solid #28a745; }
        .prob-low { color: #6c757d; background: #e9ecef; border-left: 4px solid #6c757d; }

        /* NEW - Step 5 Portfolio Optimization Styles */
        .optimization-container { max-width: 1200px; margin: 0 auto; }
        .allocation-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
        .allocation-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .allocation-card h4 { margin-bottom: 15px; color: #333; font-size: 1.1em; }
        .allocation-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .allocation-label { font-weight: 500; color: #555; }
        .allocation-percent { font-weight: bold; font-size: 1.1em; color: #667eea; }
        .allocation-bar { height: 6px; background: #e9ecef; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .allocation-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s ease; }
        
        .optimization-metrics { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .metric-item { text-align: center; }
        .metric-value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .metric-label { font-size: 0.9em; color: #666; margin-top: 5px; }
        
        .optimization-notes { background: #e7f1ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin: 20px 0; }
        .optimization-notes h4 { color: #0066cc; margin-bottom: 10px; }
        .optimization-notes ul { margin-left: 20px; }
        .optimization-notes li { margin-bottom: 5px; color: #004499; }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 0; width: 90%; max-width: 600px; border-radius: 8px; }
        .modal-header { background: #667eea; color: white; padding: 20px; border-radius: 8px 8px 0 0; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; text-align: right; border-top: 1px solid #dee2e6; }
        
        /* File upload styles */
        .file-upload {
            border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center;
            background: #f8f9fa; cursor: pointer; transition: all 0.3s;
        }
        .file-upload:hover { border-color: #667eea; background: #e9ecef; }
        .file-upload.dragover { border-color: #667eea; background: #e7f1ff; }
        
        /* Philosophy styles */
        .philosophy-content { max-width: 800px; margin: 0 auto; }
        .philosophy-intro { margin-bottom: 30px; }
        .acknowledgment { text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .acknowledgment label { display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>HCP Portfolio Tracker v6.5.3</h1>
            <div class="version-info">
                Core-Integrated Architecture | Steps 1-5 Functional | PortfolioOptimizer v1.0
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-bar" id="progress-bar">
            <!-- Progress indicators will be generated by TrackerCore -->
        </div>
        
        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-button" id="btn-prev">‚Üê Previous</button>
            <div id="step-title">Step 1: Investment Philosophy</div>
            <button class="nav-button" id="btn-next">Next ‚Üí</button>
        </div>
        
        <!-- Content Area -->
        <div class="content">
            <!-- Step 1: Philosophy -->
            <div id="step-1" class="step-content active">
                <div class="philosophy-content">
                    <div class="philosophy-intro">
                        <h2>Welcome to the Humble Conviction Portfolio System</h2>
                        <p>This Investment Policy Statement outlines a systematic, probability-weighted approach to portfolio management based on macro regime analysis.</p>
                    </div>
                    <div class="acknowledgment">
                        <label>
                            <input type="checkbox" id="philosophy-checkbox">
                            <strong>I understand and acknowledge the investment philosophy</strong>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Data Import -->
            <div id="step-2" class="step-content">
                <div class="data-section">
                    <h2>Import Data Files</h2>
                    
                    <div style="margin-bottom: 30px;">
                        <h3>Monthly Update File</h3>
                        <div class="file-upload" onclick="document.getElementById('monthly-file').click()">
                            <input type="file" id="monthly-file" accept=".json" style="display: none;">
                            <div id="monthly-status">
                                üìÅ Click to select monthly update file or drag & drop<br>
                                <small>Format: hcp_data_monthly_YYYYMMDD_HHMMSS.json</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sample Data Generator -->
                    <div>
                        <h3>Or Generate Sample Data (FileHandler v1.5)</h3>
                        <p>Generate momentum-aware sample data for testing and demonstration:</p>
                        <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="nav-button" onclick="generateSampleData('tech_boom')">Tech Boom</button>
                            <button class="nav-button" onclick="generateSampleData('usd_strength')">USD Strength</button>
                            <button class="nav-button" onclick="generateSampleData('pe_reversion')">P/E Reversion</button>
                            <button class="nav-button" onclick="generateSampleData('international')">International</button>
                            <button class="nav-button" onclick="generateSampleData('mixed_signals')">Mixed Signals</button>
                        </div>
                    </div>
                    
                    <!-- Data Editor Section -->
                    <div id="data-editor-section" style="display: none; margin-top: 30px;">
                        <h3>Data Editor</h3>
                        <div id="data-table-container">
                            <!-- DataEditor table will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Theme Analysis -->
            <div id="step-3" class="step-content">
                <h2>Theme Analysis</h2>
                <div id="theme-container">
                    <p>Load data in Step 2 to begin theme analysis.</p>
                </div>
            </div>
            
            <!-- Step 4: Scenario Analysis -->
            <div id="step-4" class="step-content">
                <div class="scenario-matrix">
                    <h2>16-Scenario Probability Matrix</h2>
                    <p>Based on theme probabilities from Step 3, here are all possible scenario combinations ranked by probability:</p>
                    
                    <div id="scenario-summary" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <!-- Scenario summary stats will be displayed here -->
                    </div>
                    
                    <div id="scenario-container">
                        <p>Complete Step 3 to generate scenario analysis.</p>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Portfolio Optimization (NEW!) -->
            <div id="step-5" class="step-content">
                <div class="optimization-container">
                    <h2>Portfolio Optimization</h2>
                    <p>Probability-weighted mean-variance optimization across scenarios using IPS v3.10 methodology:</p>
                    
                    <!-- Optimization Summary -->
                    <div id="optimization-summary" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <!-- Optimization summary will be displayed here -->
                    </div>
                    
                    <!-- Asset Allocation Results -->
                    <div id="allocation-container">
                        <p>Complete Step 4 to begin portfolio optimization.</p>
                    </div>
                    
                    <!-- Optimization Metrics -->
                    <div id="metrics-container" style="display: none;">
                        <!-- Metrics will be displayed here -->
                    </div>
                </div>
            </div>
            
            <!-- Placeholder Steps 6-10 -->
            <div id="step-6" class="step-content">
                <h2>Current Positions</h2>
                <p>Step 6 functionality will be implemented in a future release.</p>
                <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px;">
                    <strong>Coming Soon:</strong> Portfolio position entry and analysis.
                </div>
            </div>
            
            <div id="step-7" class="step-content">
                <h2>Rebalancing Trades</h2>
                <p>Step 7 functionality will be implemented in a future release.</p>
                <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px;">
                    <strong>Coming Soon:</strong> Trade generation and execution planning.
                </div>
            </div>
            
            <div id="step-8" class="step-content">
                <h2>History</h2>
                <p>Step 8 functionality will be implemented in a future release.</p>
                <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px;">
                    <strong>Coming Soon:</strong> Historical tracking and performance attribution.
                </div>
            </div>
            
            <div id="step-9" class="step-content">
                <h2>Report</h2>
                <p>Step 9 functionality will be implemented in a future release.</p>
                <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px;">
                    <strong>Coming Soon:</strong> Comprehensive analysis report generation.
                </div>
            </div>
            
            <div id="step-10" class="step-content">
                <h2>Export</h2>
                <p>Step 10 functionality will be implemented in a future release.</p>
                <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border-radius: 8px;">
                    <strong>Coming Soon:</strong> Data export and system integration.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit Indicator</h3>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="nav-button" onclick="DataEditor.closeEditModal()">Cancel</button>
                <button class="nav-button" onclick="saveIndicatorEdit()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        // EMBEDDED TRACKER CORE v1.0 - Foundation Architecture
        const TrackerCore = {
            version: '1.0',
            currentStep: 1,
            completedSteps: [],
            
            // Core state structure - NEVER modify this
            state: {
                philosophyAcknowledged: false,
                initializationData: null,
                monthlyData: null,
                dataQuality: {},
                manualOverrides: {},
                themeProbabilities: {},
                scenarioProbabilities: [],
                optimizedAllocation: {} // NEW for Step 5
            },

            init: function() {
                this.loadState();
                this.navigateToStep(this.currentStep);
                this.setupEventListeners();
                console.log('TrackerCore v1.0 initialized with embedded modules');
            },

            // ROBUST navigation from core
            navigateToStep: function(step) {
                if (step < 1 || step > 10) return false;
                
                if (!this.canNavigateToStep(step)) {
                    console.warn(`Cannot navigate to step ${step} - validation failed`);
                    return false;
                }

                this.currentStep = step;
                this.updateStepDisplay();
                this.updateStepIndicators();
                this.updateNavigation();
                this.saveState();
                
                console.log(`Navigated to step ${step}`);
                return true;
            },

            // ENHANCED validation logic from core
            canNavigateToStep: function(step) {
                if (step === 1) return true;
                
                // Must complete previous steps in order
                for (let i = 1; i < step; i++) {
                    if (!this.isStepComplete(i)) {
                        return false;
                    }
                }
                return true;
            },

            // IMPROVED step completion checking from core
            isStepComplete: function(step) {
                switch(step) {
                    case 1: 
                        return this.state.philosophyAcknowledged;
                    case 2: 
                        return this.state.monthlyData !== null;
                    case 3: 
                        return Object.keys(this.state.themeProbabilities).length > 0;
                    case 4:
                        return this.state.scenarioProbabilities.length === 16;
                    case 5:
                        return Object.keys(this.state.optimizedAllocation).length > 0;
                    default: 
                        return this.completedSteps.includes(step);
                }
            },

            // ROBUST step display from core
            updateStepDisplay: function() {
                // Hide all steps
                document.querySelectorAll('.step-content').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Show current step
                const currentStepEl = document.getElementById(`step-${this.currentStep}`);
                if (currentStepEl) {
                    currentStepEl.classList.add('active');
                }
                
                // Update title
                const titles = [
                    'Investment Philosophy', 'Data Import & Edit', 'Theme Analysis',
                    'Scenario Analysis', 'Portfolio Optimization', 'Current Positions',
                    'Rebalancing Trades', 'History', 'Report', 'Export'
                ];
                
                const titleEl = document.getElementById('step-title');
                if (titleEl) {
                    titleEl.textContent = `Step ${this.currentStep}: ${titles[this.currentStep - 1]}`;
                }
            },

            // ENHANCED step indicators from core
            updateStepIndicators: function() {
                const progressBar = document.getElementById('progress-bar');
                if (!progressBar) return;
                
                let html = '';
                for (let i = 1; i <= 10; i++) {
                    const isActive = i === this.currentStep;
                    const isCompleted = this.isStepComplete(i);
                    const isLocked = !this.canNavigateToStep(i);
                    
                    let classes = ['step-indicator'];
                    if (isActive) classes.push('active');
                    if (isCompleted) classes.push('completed');
                    if (isLocked) classes.push('locked');
                    
                    const statusLabels = ['Philosophy', 'Data', 'Themes', 'Scenarios', 'Optimize', 'Positions', 'Trades', 'History', 'Report', 'Export'];
                    
                    html += `
                        <div class="${classes.join(' ')}" onclick="TrackerCore.navigateToStep(${i})">
                            <div>Step ${i}</div>
                            <small>${statusLabels[i-1]}</small>
                        </div>
                    `;
                }
                
                progressBar.innerHTML = html;
            },

            updateNavigation: function() {
                const prevBtn = document.getElementById('btn-prev');
                const nextBtn = document.getElementById('btn-next');
                
                if (prevBtn) {
                    prevBtn.disabled = this.currentStep <= 1;
                    prevBtn.onclick = () => this.navigateToStep(this.currentStep - 1);
                }
                
                if (nextBtn) {
                    nextBtn.disabled = !this.canNavigateToStep(this.currentStep + 1);
                    nextBtn.onclick = () => this.navigateToStep(this.currentStep + 1);
                }
            },

            setupEventListeners: function() {
                // Philosophy checkbox
                const checkbox = document.getElementById('philosophy-checkbox');
                if (checkbox) {
                    checkbox.addEventListener('change', (e) => {
                        this.state.philosophyAcknowledged = e.target.checked;
                        if (e.target.checked && !this.completedSteps.includes(1)) {
                            this.completedSteps.push(1);
                        }
                        this.updateStepIndicators();
                        this.updateNavigation();
                        this.saveState();
                    });
                }

                // File upload
                const monthlyFile = document.getElementById('monthly-file');
                if (monthlyFile) {
                    monthlyFile.addEventListener('change', handleMonthlyFile);
                }
                
                // Modal event listeners
                window.addEventListener('click', (event) => {
                    const modal = document.getElementById('edit-modal');
                    if (event.target === modal) {
                        DataEditor.closeEditModal();
                    }
                });
                
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        DataEditor.closeEditModal();
                    }
                });
            },

            saveState: function() {
                const stateToSave = {
                    version: '6.5.3',
                    currentStep: this.currentStep,
                    completedSteps: this.completedSteps,
                    state: this.state,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('hcp-tracker-v653-state', JSON.stringify(stateToSave));
            },

            loadState: function() {
                try {
                    const savedState = localStorage.getItem('hcp-tracker-v653-state') || 
                                    localStorage.getItem('hcp-tracker-v652-state') ||
                                    localStorage.getItem('hcp-tracker-v651-state') ||
                                    localStorage.getItem('hcp-tracker-v650-state');
                    
                    if (savedState) {
                        const parsed = JSON.parse(savedState);
                        this.currentStep = parsed.currentStep || 1;
                        this.completedSteps = parsed.completedSteps || [];
                        this.state = { ...this.state, ...parsed.state };
                        console.log('TrackerCore state restored from localStorage');
                    }
                } catch (error) {
                    console.error('Error loading state:', error);
                }
            }
        };

        // EMBEDDED FILE HANDLER v1.5 - Momentum-Aware Sample Data
        const FileHandler = {
            version: '1.5',
            
            generateSampleData: function(type, scenario) {
                console.log(`FileHandler v1.5: Generating ${scenario} sample data`);
                
                const scenarios = {
                    'tech_boom': { usd: 0.25, ai: 0.80, pe: 0.35, intl: 0.30 },
                    'usd_strength': { usd: 0.75, ai: 0.20, pe: 0.25, intl: 0.15 },
                    'pe_reversion': { usd: 0.40, pe: 0.80, ai: 0.30, intl: 0.25 },
                    'international': { intl: 0.80, usd: 0.20, ai: 0.25, pe: 0.30 },
                    'mixed_signals': { usd: 0.50, ai: 0.50, pe: 0.50, intl: 0.50 }
                };
                
                const targetProbs = scenarios[scenario] || scenarios['mixed_signals'];
                
                return {
                    version: '1.5',
                    type: 'monthly',
                    timestamp: new Date().toISOString(),
                    scenario: scenario,
                    indicators: this.generateIndicatorData(targetProbs)
                };
            },
            
            generateIndicatorData: function(targetProbs) {
                // Generate realistic indicator data that will produce target theme probabilities
                return {
                    usd: {
                        dxy: this.generateMomentumData(97.5, targetProbs.usd > 0.5 ? -0.02 : 0.02),
                        gold: this.generateMomentumData(1950, targetProbs.usd > 0.5 ? 0.015 : -0.015),
                        yuanSwift: this.generateMomentumData(2.1, targetProbs.usd > 0.5 ? 0.03 : -0.03),
                        reserveShare: this.generateMomentumData(58.5, targetProbs.usd > 0.5 ? -0.01 : 0.01)
                    },
                    ai: {
                        productivity: this.generateMomentumData(115, targetProbs.ai > 0.5 ? 0.025 : -0.01),
                        qqqSpy: this.generateMomentumData(0.88, targetProbs.ai > 0.5 ? 0.02 : -0.02),
                        netMargins: this.generateMomentumData(12.5, targetProbs.ai > 0.5 ? 0.015 : -0.015)
                    },
                    pe: {
                        forwardPE: this.generateMomentumData(22, targetProbs.pe > 0.5 ? 0.03 : -0.02),
                        cape: this.generateMomentumData(32, targetProbs.pe > 0.5 ? 0.025 : -0.015),
                        riskPremium: this.generateMomentumData(2.5, targetProbs.pe > 0.5 ? -0.02 : 0.03)
                    },
                    intl: {
                        spVsWorld: this.generateMomentumData(-1.2, targetProbs.intl > 0.5 ? -0.03 : 0.02),
                        usAcwi: this.generateMomentumData(60, targetProbs.intl > 0.5 ? -0.01 : 0.01),
                        dxyLevel: this.generateMomentumData(97.5, targetProbs.intl > 0.5 ? -0.02 : 0.02),
                        ticFlows: this.generateMomentumData(125, targetProbs.intl > 0.5 ? 0.02 : -0.02)
                    }
                };
            },
            
            generateMomentumData: function(baseValue, momentum) {
                const history = [];
                let value = baseValue * (1 - momentum * 6); // Start 6 periods back
                
                // Generate 6-period history with momentum
                for (let i = 0; i < 6; i++) {
                    history.push(value);
                    value *= (1 + momentum + (Math.random() - 0.5) * 0.005); // Add small noise
                }
                
                return {
                    current: history[5],
                    history: history,
                    freshness: 'fresh',
                    source: 'FileHandler_v1.5_synthetic'
                };
            }
        };

        // EMBEDDED THEME CALCULATOR v2.9 - IPS v3.10 Compliant
        const ThemeCalculator = {
            version: '2.9',
            
            calculateThemeAnalysis: function(data) {
                if (!data || !data.indicators) {
                    return { error: 'Invalid data structure' };
                }
                
                console.log('ThemeCalculator v2.9: Starting theme analysis...');
                
                const themes = {
                    usd: this.calculateThemeProbability(data.indicators.usd),
                    ai: this.calculateThemeProbability(data.indicators.ai),
                    pe: this.calculateThemeProbability(data.indicators.pe),
                    intl: this.calculateThemeProbability(data.indicators.intl)
                };
                
                // Generate 16 scenarios
                const scenarios = this.generateScenarios(themes);
                
                return {
                    version: '2.9',
                    methodology: 'IPS v3.10 Momentum Analysis',
                    timestamp: new Date().toISOString(),
                    themes: themes,
                    scenarios: scenarios
                };
            },
            
            calculateThemeProbability: function(themeData) {
                if (!themeData) return 0.15; // Default neutral
                
                let totalMomentum = 0;
                let indicatorCount = 0;
                
                Object.values(themeData).forEach(indicator => {
                    if (indicator.history && indicator.history.length >= 6) {
                        const current = indicator.current;
                        const sixBack = indicator.history[0];
                        const momentum = (current - sixBack) / sixBack;
                        totalMomentum += momentum;
                        indicatorCount++;
                    }
                });
                
                if (indicatorCount === 0) return 0.15;
                
                const avgMomentum = totalMomentum / indicatorCount;
                
                // Convert momentum to probability (sigmoid-like function)
                const probability = 0.15 + 0.7 / (1 + Math.exp(-avgMomentum * 10));
                
                return Math.max(0.05, Math.min(0.95, probability));
            },
            
            // EXISTING generateScenarios function - Wire this up to Step 4!
            generateScenarios: function(themes) {
                const scenarios = [];
                
                // Generate all 16 binary combinations (0000-1111)
                for (let i = 0; i < 16; i++) {
                    const hasUSD = (i & 1) !== 0;   // Bit 0
                    const hasAI = (i & 2) !== 0;    // Bit 1  
                    const hasPE = (i & 4) !== 0;    // Bit 2
                    const hasINTL = (i & 8) !== 0;  // Bit 3
                    
                    // Calculate joint probability
                    const probability = 
                        (hasUSD ? themes.usd : (1 - themes.usd)) *
                        (hasAI ? themes.ai : (1 - themes.ai)) *
                        (hasPE ? themes.pe : (1 - themes.pe)) *
                        (hasINTL ? themes.intl : (1 - themes.intl));
                    
                    let name = [];
                    if (hasUSD) name.push('USD‚Üì');
                    if (hasAI) name.push('AI‚Üë');
                    if (hasPE) name.push('P/E‚Üì');
                    if (hasINTL) name.push('INTL‚Üë');
                    
                    scenarios.push({
                        id: i + 1,
                        binary: i.toString(2).padStart(4, '0'),
                        name: name.length > 0 ? name.join(' + ') : 'Base Case',
                        probability: probability,
                        rank: 0,
                        themes: { usd: hasUSD, ai: hasAI, pe: hasPE, intl: hasINTL }
                    });
                }
                
                // Sort by probability and assign ranks
                scenarios.sort((a, b) => b.probability - a.probability);
                scenarios.forEach((scenario, index) => {
                    scenario.rank = index + 1;
                });
                
                return scenarios;
            },

            displayThemeResults: function(analysis, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const themeNames = {
                    usd: 'USD Dominance Decline',
                    ai: 'AI Productivity Boom', 
                    pe: 'P/E Mean Reversion',
                    intl: 'International Outperformance'
                };
                
                let html = `
                    <div class="theme-analysis-v651">
                        <div class="analysis-header">
                            <h3>Theme Analysis - ${analysis.methodology}</h3>
                            <div class="analysis-meta">Version ${analysis.version} | ${new Date(analysis.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="theme-probabilities">
                            <h4>Theme Probabilities</h4>
                `;
                
                Object.entries(analysis.themes).forEach(([key, probability]) => {
                    const percentage = (probability * 100).toFixed(1);
                    const fillColor = probability > 0.6 ? '#28a745' : probability > 0.4 ? '#ffc107' : '#dc3545';
                    
                    html += `
                        <div class="theme-item">
                            <div class="theme-header">
                                <div class="theme-name">${themeNames[key]}</div>
                                <div class="theme-percentage">${percentage}%</div>
                            </div>
                            <div class="theme-bar">
                                <div class="theme-fill" style="width: ${percentage}%; background: ${fillColor};"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                container.innerHTML = html;
                
                // Auto-trigger Step 4 scenario display if we have theme probabilities
                if (analysis.scenarios && analysis.scenarios.length === 16) {
                    this.displayScenarioMatrix(analysis.scenarios);
                }
            },
            
            // Display scenario matrix for Step 4
            displayScenarioMatrix: function(scenarios) {
                const container = document.getElementById('scenario-container');
                const summary = document.getElementById('scenario-summary');
                if (!container || !summary) return;
                
                // Update TrackerCore state
                TrackerCore.state.scenarioProbabilities = scenarios;
                
                // Display summary statistics
                const topScenario = scenarios[0];
                const totalProb = scenarios.reduce((sum, s) => sum + s.probability, 0);
                
                summary.innerHTML = `
                    <div style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <strong>Top Scenario</strong><br>
                            ${topScenario.name}<br>
                            <span style="color: #dc3545; font-size: 1.2em;">${(topScenario.probability * 100).toFixed(1)}%</span>
                        </div>
                        <div>
                            <strong>Scenarios > 10%</strong><br>
                            ${scenarios.filter(s => s.probability > 0.1).length} of 16<br>
                            <span style="color: #28a745; font-size: 1.2em;">${(scenarios.filter(s => s.probability > 0.1).length / 16 * 100).toFixed(0)}%</span>
                        </div>
                        <div>
                            <strong>Probability Check</strong><br>
                            Sum of all scenarios<br>
                            <span style="color: ${Math.abs(totalProb - 1) < 0.01 ? '#28a745' : '#dc3545'}; font-size: 1.2em;">${(totalProb * 100).toFixed(1)}%</span>
                        </div>
                    </div>
                `;
                
                // Generate scenario grid
                let html = '<div class="scenario-grid">';
                
                scenarios.forEach(scenario => {
                    const probability = scenario.probability * 100;
                    let probClass = 'prob-low';
                    if (probability > 15) probClass = 'prob-very-high';
                    else if (probability > 10) probClass = 'prob-high';
                    else if (probability > 5) probClass = 'prob-medium';
                    
                    html += `
                        <div class="scenario-card ${probClass}">
                            <div class="scenario-rank">Rank #${scenario.rank}</div>
                            <div class="scenario-name">${scenario.name}</div>
                            <div class="scenario-probability">${probability.toFixed(2)}%</div>
                            <div class="scenario-binary">Binary: ${scenario.binary}</div>
                            <div class="scenario-themes">
                                ${Object.entries(scenario.themes).map(([theme, active]) => 
                                    active ? theme.toUpperCase() : theme.toLowerCase()
                                ).join(' | ')}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Mark Step 4 as complete
                if (!TrackerCore.completedSteps.includes(4)) {
                    TrackerCore.completedSteps.push(4);
                }
                TrackerCore.updateStepIndicators();
                TrackerCore.updateNavigation();
                TrackerCore.saveState();
                
                // Auto-trigger Step 5 portfolio optimization
                PortfolioOptimizer.runOptimization(scenarios);
                
                console.log('Step 4: 16-scenario matrix displayed successfully');
            }
        };

        // NEW - EMBEDDED PORTFOLIO OPTIMIZER v1.0 - IPS v3.10 Mean-Variance Optimization
        const PortfolioOptimizer = {
            version: '1.0',
            
            // Asset universe per IPS v3.10
            assetUniverse: {
                // Core Holdings (60% baseline)
                'SPY': { name: 'SPDR S&P 500 ETF', category: 'US_Equity', baseline: 35.0 },
                'QQQ': { name: 'Invesco QQQ ETF', category: 'US_Tech', baseline: 15.0 },
                'SCHG': { name: 'Schwab US Large-Cap Growth', category: 'US_Growth', baseline: 10.0 },
                
                // International (20% baseline)
                'VEA': { name: 'Vanguard Developed Markets', category: 'Developed_Intl', baseline: 12.0 },
                'VWO': { name: 'Vanguard Emerging Markets', category: 'Emerging_Markets', baseline: 8.0 },
                
                // Defensive/Alternative (20% baseline)
                'TLT': { name: 'iShares 20+ Year Treasury', category: 'Long_Treasuries', baseline: 8.0 },
                'GLD': { name: 'SPDR Gold Shares', category: 'Gold', baseline: 5.0 },
                'VNQ': { name: 'Vanguard Real Estate', category: 'REITs', baseline: 4.0 },
                'DBC': { name: 'Invesco DB Commodity', category: 'Commodities', baseline: 3.0 }
            },
            
            runOptimization: function(scenarios) {
                console.log('PortfolioOptimizer v1.0: Starting mean-variance optimization...');
                
                if (!scenarios || scenarios.length !== 16) {
                    console.error('Invalid scenarios for optimization');
                    return;
                }
                
                // Calculate probability-weighted optimal allocation
                const allocation = this.calculateOptimalAllocation(scenarios);
                
                // Apply risk constraints and bounds
                const constrainedAllocation = this.applyConstraints(allocation);
                
                // Calculate optimization metrics
                const metrics = this.calculateMetrics(constrainedAllocation, scenarios);
                
                // Store results in TrackerCore state
                TrackerCore.state.optimizedAllocation = {
                    allocation: constrainedAllocation,
                    metrics: metrics,
                    methodology: 'IPS v3.10 Mean-Variance Optimization',
                    timestamp: new Date().toISOString()
                };
                
                // Display results
                this.displayOptimizationResults(constrainedAllocation, metrics);
                
                // Mark Step 5 as complete
                if (!TrackerCore.completedSteps.includes(5)) {
                    TrackerCore.completedSteps.push(5);
                }
                TrackerCore.updateStepIndicators();
                TrackerCore.updateNavigation();
                TrackerCore.saveState();
                
                console.log('Step 5: Portfolio optimization completed successfully');
            },
            
            calculateOptimalAllocation: function(scenarios) {
                // Simplified mean-variance optimization using scenario probabilities
                const allocation = {};
                
                // Initialize with baseline allocation
                Object.entries(this.assetUniverse).forEach(([symbol, info]) => {
                    allocation[symbol] = info.baseline;
                });
                
                // Apply theme-based tilts based on scenario probabilities
                const themeTilts = this.calculateThemeTilts(scenarios);
                
                // USD Theme tilt - if USD weakening likely, increase international
                if (themeTilts.usd > 0.5) {
                    allocation['VEA'] += 5;
                    allocation['VWO'] += 3;
                    allocation['GLD'] += 2;
                    allocation['SPY'] -= 8;
                    allocation['QQQ'] -= 2;
                }
                
                // AI Theme tilt - if AI boom likely, increase tech
                if (themeTilts.ai > 0.5) {
                    allocation['QQQ'] += 8;
                    allocation['SCHG'] += 4;
                    allocation['SPY'] -= 6;
                    allocation['TLT'] -= 4;
                    allocation['VNQ'] -= 2;
                }
                
                // P/E Reversion tilt - if valuations stretched, increase defensive
                if (themeTilts.pe > 0.5) {
                    allocation['TLT'] += 6;
                    allocation['GLD'] += 3;
                    allocation['VNQ'] += 2;
                    allocation['SPY'] -= 7;
                    allocation['QQQ'] -= 4;
                }
                
                // International theme tilt - if international outperformance likely
                if (themeTilts.intl > 0.5) {
                    allocation['VEA'] += 6;
                    allocation['VWO'] += 4;
                    allocation['SPY'] -= 8;
                    allocation['SCHG'] -= 2;
                }
                
                // Normalize to 100%
                const totalWeight = Object.values(allocation).reduce((sum, weight) => sum + weight, 0);
                Object.keys(allocation).forEach(symbol => {
                    allocation[symbol] = (allocation[symbol] / totalWeight) * 100;
                });
                
                return allocation;
            },
            
            calculateThemeTilts: function(scenarios) {
                // Weight theme probabilities by scenario probabilities
                const themeTilts = { usd: 0, ai: 0, pe: 0, intl: 0 };
                
                scenarios.forEach(scenario => {
                    const weight = scenario.probability;
                    if (scenario.themes.usd) themeTilts.usd += weight;
                    if (scenario.themes.ai) themeTilts.ai += weight;
                    if (scenario.themes.pe) themeTilts.pe += weight;
                    if (scenario.themes.intl) themeTilts.intl += weight;
                });
                
                return themeTilts;
            },
            
            applyConstraints: function(allocation) {
                // Apply practical constraints per IPS v3.10
                const constraints = {
                    'SPY': { min: 20, max: 50 },    // Core US exposure
                    'QQQ': { min: 5, max: 30 },     // Tech exposure limits
                    'SCHG': { min: 5, max: 20 },    // Growth exposure
                    'VEA': { min: 8, max: 25 },     // Developed international
                    'VWO': { min: 3, max: 15 },     // Emerging markets
                    'TLT': { min: 5, max: 25 },     // Treasury bonds
                    'GLD': { min: 2, max: 15 },     // Gold exposure
                    'VNQ': { min: 2, max: 10 },     // REITs
                    'DBC': { min: 0, max: 8 }       // Commodities
                };
                
                const constrainedAllocation = { ...allocation };
                
                // Apply min/max constraints
                Object.entries(constraints).forEach(([symbol, bounds]) => {
                    if (constrainedAllocation[symbol] < bounds.min) {
                        constrainedAllocation[symbol] = bounds.min;
                    }
                    if (constrainedAllocation[symbol] > bounds.max) {
                        constrainedAllocation[symbol] = bounds.max;
                    }
                });
                
                // Renormalize to 100%
                const totalWeight = Object.values(constrainedAllocation).reduce((sum, weight) => sum + weight, 0);
                Object.keys(constrainedAllocation).forEach(symbol => {
                    constrainedAllocation[symbol] = (constrainedAllocation[symbol] / totalWeight) * 100;
                });
                
                return constrainedAllocation;
            },
            
            calculateMetrics: function(allocation, scenarios) {
                // Calculate portfolio metrics
                const totalEquity = allocation['SPY'] + allocation['QQQ'] + allocation['SCHG'] + 
                                   allocation['VEA'] + allocation['VWO'];
                const totalDefensive = allocation['TLT'] + allocation['GLD'];
                const totalAlternative = allocation['VNQ'] + allocation['DBC'];
                const internationalWeight = allocation['VEA'] + allocation['VWO'];
                
                // Risk score based on equity allocation
                const riskScore = totalEquity > 70 ? 'Aggressive' : 
                                 totalEquity > 50 ? 'Moderate' : 'Conservative';
                
                // Diversification score
                const maxWeight = Math.max(...Object.values(allocation));
                const diversificationScore = maxWeight < 35 ? 'High' : 
                                           maxWeight < 50 ? 'Medium' : 'Low';
                
                return {
                    totalEquity: totalEquity.toFixed(1),
                    totalDefensive: totalDefensive.toFixed(1),
                    totalAlternative: totalAlternative.toFixed(1),
                    internationalWeight: internationalWeight.toFixed(1),
                    riskScore: riskScore,
                    diversificationScore: diversificationScore,
                    activeScenarios: scenarios.filter(s => s.probability > 0.05).length,
                    topScenarioWeight: (Math.max(...scenarios.map(s => s.probability)) * 100).toFixed(1)
                };
            },
            
            displayOptimizationResults: function(allocation, metrics) {
                const summaryContainer = document.getElementById('optimization-summary');
                const allocationContainer = document.getElementById('allocation-container');
                const metricsContainer = document.getElementById('metrics-container');
                
                if (!summaryContainer || !allocationContainer || !metricsContainer) return;
                
                // Display summary
                summaryContainer.innerHTML = `
                    <div style="display: flex; justify-content: space-around; text-align: center;">
                        <div>
                            <strong>Risk Profile</strong><br>
                            <span style="color: ${metrics.riskScore === 'Aggressive' ? '#dc3545' : metrics.riskScore === 'Moderate' ? '#ffc107' : '#28a745'}; font-size: 1.2em;">${metrics.riskScore}</span><br>
                            <small>${metrics.totalEquity}% Equity</small>
                        </div>
                        <div>
                            <strong>Diversification</strong><br>
                            <span style="color: ${metrics.diversificationScore === 'High' ? '#28a745' : '#ffc107'}; font-size: 1.2em;">${metrics.diversificationScore}</span><br>
                            <small>9 Asset Classes</small>
                        </div>
                        <div>
                            <strong>Global Exposure</strong><br>
                            <span style="color: #667eea; font-size: 1.2em;">${metrics.internationalWeight}%</span><br>
                            <small>International</small>
                        </div>
                    </div>
                `;
                
                // Display allocation results
                let allocationHtml = `
                    <h3>Optimized Asset Allocation</h3>
                    <div class="allocation-summary">
                        <div class="allocation-card">
                            <h4>üá∫üá∏ US Equity (${(parseFloat(allocation['SPY']) + parseFloat(allocation['QQQ']) + parseFloat(allocation['SCHG'])).toFixed(1)}%)</h4>
                `;
                
                ['SPY', 'QQQ', 'SCHG'].forEach(symbol => {
                    const info = this.assetUniverse[symbol];
                    const percent = allocation[symbol];
                    allocationHtml += `
                        <div class="allocation-item">
                            <div>
                                <div class="allocation-label">${symbol} - ${info.name}</div>
                                <div class="allocation-bar">
                                    <div class="allocation-fill" style="width: ${percent * 2}%;"></div>
                                </div>
                            </div>
                            <div class="allocation-percent">${percent.toFixed(1)}%</div>
                        </div>
                    `;
                });
                
                allocationHtml += `
                        </div>
                        <div class="allocation-card">
                            <h4>üåç International (${metrics.internationalWeight}%)</h4>
                `;
                
                ['VEA', 'VWO'].forEach(symbol => {
                    const info = this.assetUniverse[symbol];
                    const percent = allocation[symbol];
                    allocationHtml += `
                        <div class="allocation-item">
                            <div>
                                <div class="allocation-label">${symbol} - ${info.name}</div>
                                <div class="allocation-bar">
                                    <div class="allocation-fill" style="width: ${percent * 2}%;"></div>
                                </div>
                            </div>
                            <div class="allocation-percent">${percent.toFixed(1)}%</div>
                        </div>
                    `;
                });
                
                allocationHtml += `
                        </div>
                        <div class="allocation-card">
                            <h4>üõ°Ô∏è Defensive & Alternative (${(parseFloat(metrics.totalDefensive) + parseFloat(metrics.totalAlternative)).toFixed(1)}%)</h4>
                `;
                
                ['TLT', 'GLD', 'VNQ', 'DBC'].forEach(symbol => {
                    const info = this.assetUniverse[symbol];
                    const percent = allocation[symbol];
                    allocationHtml += `
                        <div class="allocation-item">
                            <div>
                                <div class="allocation-label">${symbol} - ${info.name}</div>
                                <div class="allocation-bar">
                                    <div class="allocation-fill" style="width: ${percent * 2}%;"></div>
                                </div>
                            </div>
                            <div class="allocation-percent">${percent.toFixed(1)}%</div>
                        </div>
                    `;
                });
                
                allocationHtml += `
                        </div>
                    </div>
                `;
                
                // Add implementation notes
                allocationHtml += `
                    <div class="optimization-notes">
                        <h4>üìã Implementation Notes</h4>
                        <ul>
                            <li>Allocation based on probability-weighted scenario analysis</li>
                            <li>Theme tilts applied based on macro regime probabilities</li>
                            <li>Risk constraints per IPS v3.10 specifications enforced</li>
                            <li>Total of ${metrics.activeScenarios} scenarios have >5% probability</li>
                            <li>Top scenario (${metrics.topScenarioWeight}% probability) drives key tilts</li>
                        </ul>
                    </div>
                `;
                
                allocationContainer.innerHTML = allocationHtml;
                
                // Display metrics
                metricsContainer.style.display = 'block';
                metricsContainer.innerHTML = `
                    <div class="optimization-metrics">
                        <h4>Portfolio Metrics</h4>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-value">${metrics.totalEquity}%</div>
                                <div class="metric-label">Total Equity</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${metrics.totalDefensive}%</div>
                                <div class="metric-label">Defensive Assets</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${metrics.internationalWeight}%</div>
                                <div class="metric-label">International</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${metrics.activeScenarios}</div>
                                <div class="metric-label">Active Scenarios</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${metrics.riskScore}</div>
                                <div class="metric-label">Risk Profile</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${metrics.diversificationScore}</div>
                                <div class="metric-label">Diversification</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        };

        // EMBEDDED DATA EDITOR v1.0 - RESTORED FROM v6.5.2
        const DataEditor = {
            version: '1.0',
            editingIndicator: null,
            
            displayDataTable: function(data, indicators, overrides) {
                if (!data || !data.indicators) return;
                
                const container = document.getElementById('data-table-container');
                if (!container) return;
                
                let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
                html += '<thead><tr style="background: #f8f9fa;">';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Theme</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Indicator</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Current Value</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Freshness</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Source</th>';
                html += '<th style="padding: 10px; border: 1px solid #dee2e6; text-align: left;">Action</th>';
                html += '</tr></thead><tbody>';
                
                const themeNames = {
                    usd: 'USD Theme',
                    ai: 'AI Theme', 
                    pe: 'P/E Theme',
                    intl: 'International Theme'
                };
                
                Object.entries(data.indicators).forEach(([theme, themeData]) => {
                    Object.entries(themeData).forEach(([key, indicator]) => {
                        const dataKey = `${theme}_${key}`;
                        const isManual = overrides[dataKey];
                        const rowStyle = isManual ? 'background: #fff3cd; border: 1px solid #ffeaa7;' : 'border: 1px solid #dee2e6;';
                        
                        html += `<tr>`;
                        html += `<td style="padding: 10px; ${rowStyle}">${themeNames[theme] || theme}</td>`;
                        html += `<td style="padding: 10px; ${rowStyle}">${indicator.name || key}</td>`;
                        html += `<td style="padding: 10px; ${rowStyle}">${indicator.current ? indicator.current.toFixed(2) : 'N/A'}</td>`;
                        html += `<td style="padding: 10px; ${rowStyle}"><span style="color: #28a745;">‚úÖ Fresh</span></td>`;
                        html += `<td style="padding: 10px; ${rowStyle}">${isManual ? 'Manual' : indicator.source || 'Generated'}</td>`;
                        html += `<td style="padding: 10px; ${rowStyle}"><button onclick="DataEditor.openEditModal('${dataKey}', '${indicator.name || key}', ${indicator.current})" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Edit</button></td>`;
                        html += '</tr>';
                    });
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                console.log('DataEditor v1.0: Data table displayed with edit functionality');
            },
            
            openEditModal: function(dataKey, displayName, currentValue) {
                this.editingIndicator = dataKey;
                const modal = document.getElementById('edit-modal');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body');
                
                title.textContent = `Edit: ${displayName}`;
                body.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Current Value:</label>
                        <input type="number" id="indicator-value" step="0.01" value="${currentValue || ''}" 
                               placeholder="Enter new value" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Reason for Manual Override:</label>
                        <select id="edit-reason" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                            <option value="">Select reason...</option>
                            <option value="data_error">Data Collection Error</option>
                            <option value="timing_issue">Timing Issue</option>
                            <option value="market_event">Unusual Market Event</option>
                            <option value="manual_adjustment">Manual Adjustment</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Notes (Optional):</label>
                        <textarea id="edit-notes" rows="3" placeholder="Additional context..." 
                                  style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; resize: vertical;"></textarea>
                    </div>
                `;
                
                modal.style.display = 'block';
                
                // Focus on input
                setTimeout(() => {
                    document.getElementById('indicator-value').focus();
                }, 100);
            },
            
            closeEditModal: function() {
                const modal = document.getElementById('edit-modal');
                if (modal) modal.style.display = 'none';
                this.editingIndicator = null;
            },
            
            saveIndicatorEdit: function() {
                if (!this.editingIndicator) return;
                
                const newValue = parseFloat(document.getElementById('indicator-value').value);
                const reason = document.getElementById('edit-reason').value;
                const notes = document.getElementById('edit-notes').value;
                
                if (isNaN(newValue)) {
                    alert('Please enter a valid number');
                    return;
                }
                
                if (!reason) {
                    alert('Please select a reason for the manual override');
                    return;
                }
                
                // Save to TrackerCore manual overrides
                TrackerCore.state.manualOverrides[this.editingIndicator] = {
                    value: newValue,
                    reason: reason,
                    notes: notes,
                    timestamp: new Date().toISOString(),
                    originalValue: this.getOriginalValue(this.editingIndicator)
                };
                
                // Update the data structure with manual override
                this.applyManualOverride(this.editingIndicator, newValue);
                
                // Refresh the data table display
                this.displayDataTable(TrackerCore.state.monthlyData, {}, TrackerCore.state.manualOverrides);
                
                // Recalculate themes with new data
                calculateThemes();
                
                // Save state and close modal
                TrackerCore.saveState();
                this.closeEditModal();
                
                console.log(`Manual override saved for ${this.editingIndicator}: ${newValue}`);
            },
            
            getOriginalValue: function(dataKey) {
                // Extract original value from data structure
                const parts = dataKey.split('_');
                if (parts.length >= 2) {
                    const theme = parts[0];
                    const indicator = parts.slice(1).join('_');
                    
                    if (TrackerCore.state.monthlyData && 
                        TrackerCore.state.monthlyData.indicators &&
                        TrackerCore.state.monthlyData.indicators[theme] &&
                        TrackerCore.state.monthlyData.indicators[theme][indicator]) {
                        return TrackerCore.state.monthlyData.indicators[theme][indicator].current;
                    }
                }
                return null;
            },
            
            applyManualOverride: function(dataKey, newValue) {
                // Update the data structure with manual override
                const parts = dataKey.split('_');
                if (parts.length >= 2) {
                    const theme = parts[0];
                    const indicator = parts.slice(1).join('_');
                    
                    if (TrackerCore.state.monthlyData && 
                        TrackerCore.state.monthlyData.indicators &&
                        TrackerCore.state.monthlyData.indicators[theme] &&
                        TrackerCore.state.monthlyData.indicators[theme][indicator]) {
                        TrackerCore.state.monthlyData.indicators[theme][indicator].current = newValue;
                        TrackerCore.state.monthlyData.indicators[theme][indicator].source = 'manual_override';
                    }
                }
            }
        };

        // APPLICATION FUNCTIONS
        function generateSampleData(scenario) {
            console.log(`Generating ${scenario} sample data...`);
            
            const sampleData = FileHandler.generateSampleData('monthly', scenario);
            
            document.getElementById('monthly-status').innerHTML = 
                `<span class="status-good">‚úÖ ${scenario.replace('_', ' ')} sample data generated (v1.5)</span>`;
            
            // Update TrackerCore state
            TrackerCore.state.monthlyData = sampleData;
            
            if (!TrackerCore.completedSteps.includes(2)) {
                TrackerCore.completedSteps.push(2);
            }
            
            // Show data editor with generated data
            displayDataEditor();
            
            // Auto-calculate themes when data is loaded
            calculateThemes();
            
            TrackerCore.updateStepIndicators();
            TrackerCore.updateNavigation();
            TrackerCore.saveState();
            
            console.log('Sample data processed and state updated');
        }

        function displayDataEditor() {
            if (TrackerCore.state.monthlyData) {
                const container = document.getElementById('data-editor-section');
                if (container) {
                    container.style.display = 'block';
                    DataEditor.displayDataTable(TrackerCore.state.monthlyData, {}, TrackerCore.state.manualOverrides);
                }
            }
        }

        function handleMonthlyFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    document.getElementById('monthly-status').innerHTML = 
                        '<span class="status-good">‚úÖ Monthly data loaded</span>';
                    
                    TrackerCore.state.monthlyData = data;
                    if (!TrackerCore.completedSteps.includes(2)) {
                        TrackerCore.completedSteps.push(2);
                    }
                    
                    calculateThemes();
                    TrackerCore.updateStepIndicators();
                    TrackerCore.updateNavigation();
                    TrackerCore.saveState();
                    
                } catch (error) {
                    alert('Error parsing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function calculateThemes() {
            if (!TrackerCore.state.monthlyData) return;
            
            console.log('Starting theme analysis with TrackerCore integration...');
            
            const analysis = ThemeCalculator.calculateThemeAnalysis(TrackerCore.state.monthlyData);
            
            if (analysis.error) {
                document.getElementById('theme-container').innerHTML = 
                    `<div class="status-error">Error: ${analysis.error}</div>`;
                return;
            }
            
            ThemeCalculator.displayThemeResults(analysis, 'theme-container');
            
            // Update TrackerCore state
            TrackerCore.state.themeProbabilities = analysis.themes;
            if (!TrackerCore.completedSteps.includes(3)) {
                TrackerCore.completedSteps.push(3);
            }
            
            TrackerCore.updateStepIndicators();
            TrackerCore.saveState();
        }

        function saveIndicatorEdit() {
            // Bridge to DataEditor functionality
            DataEditor.saveIndicatorEdit();
        }

        // INITIALIZE SYSTEM - TrackerCore as Foundation
        window.addEventListener('load', function() {
            TrackerCore.init();
            
            // Set initial state if philosophy already acknowledged
            if (TrackerCore.state.philosophyAcknowledged) {
                document.getElementById('philosophy-checkbox').checked = true;
            }
            
            console.log('HCP Tracker v6.5.3 fully initialized with Step 5 Portfolio Optimization');
        });
    </script>
</body>
</html>