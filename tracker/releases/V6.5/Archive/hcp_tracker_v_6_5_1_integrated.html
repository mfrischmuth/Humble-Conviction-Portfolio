<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCP Portfolio Tracker v6.5.1 - Core-Integrated Architecture</title>
    <!--
    HCP PORTFOLIO TRACKER v6.5.1 - CORE-INTEGRATED ARCHITECTURE
    File: hcp_tracker_v6.5.1_core_integrated.html
    Last Updated: 2025-09-01 02:00:00 UTC
    
    MAJOR ARCHITECTURAL IMPROVEMENT:
    - Integrates tracker_core.js v1.0 as foundation
    - Maintains embedded modules for single-file deployment
    - Leverages core's robust navigation and state management
    - Preserves FileHandler v1.5 momentum-aware data generation
    - Enhanced error handling and validation from core
    
    FIXED ISSUES:
    - Consistent state management using core's structure
    - Robust navigation validation from core
    - Proper event listener management
    - Standardized localStorage handling
    -->
    <style>
        /* Same CSS as v6.5.0 - unchanged for brevity */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
        }
        .container {
            background: white; border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px; margin: 0 auto; overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; text-align: center;
        }
        .progress-bar {
            background: rgba(255,255,255,0.2); padding: 20px;
            display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;
        }
        .step-indicator {
            flex: 1; min-width: 80px; text-align: center; cursor: pointer;
            padding: 10px; border-radius: 8px; transition: all 0.3s;
        }
        .step-indicator.completed { background: rgba(255,255,255,0.3); }
        .step-indicator.active { background: #ffc107; color: #333; }
        .step-indicator.locked { opacity: 0.5; cursor: not-allowed; }
        .navigation {
            background: #f8f9fa; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #dee2e6;
        }
        .nav-button {
            background: #667eea; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            font-size: 16px; transition: background 0.3s;
        }
        .nav-button:hover:not(:disabled) { background: #5a67d8; }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .content { padding: 30px; min-height: 400px; }
        .step-content { display: none; }
        .step-content.active { display: block; }
        
        /* Additional styles for new functionality */
        .status-good { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-error { color: #dc3545; }
        .theme-analysis-v651 { max-width: 1000px; margin: 0 auto; }
        .theme-item { background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .theme-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .theme-name { font-size: 1.2em; font-weight: bold; color: #333; }
        .theme-percentage { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .theme-bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
        .theme-fill { height: 100%; transition: width 0.5s ease; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>HCP Portfolio Tracker v6.5.1</h1>
            <div class="version-info">
                Core-Integrated Architecture | TrackerCore v1.0 + FileHandler v1.5
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-bar" id="progress-bar">
            <!-- Progress indicators will be generated by TrackerCore -->
        </div>
        
        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-button" id="btn-prev">‚Üê Previous</button>
            <div id="step-title">Step 1: Investment Philosophy</div>
            <button class="nav-button" id="btn-next">Next ‚Üí</button>
        </div>
        
        <!-- Content Area -->
        <div class="content">
            <!-- Step 1: Philosophy -->
            <div id="step-1" class="step-content active">
                <div class="philosophy-content">
                    <div class="philosophy-intro">
                        <h2>Welcome to the Humble Conviction Portfolio System</h2>
                        <p>This Investment Policy Statement outlines a systematic, probability-weighted approach to portfolio management based on macro regime analysis.</p>
                    </div>
                    <div class="acknowledgment">
                        <label>
                            <input type="checkbox" id="philosophy-checkbox">
                            <strong>I understand and acknowledge the investment philosophy</strong>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Data Import -->
            <div id="step-2" class="step-content">
                <div class="data-section">
                    <h2>Import Data Files</h2>
                    
                    <div style="margin-bottom: 30px;">
                        <h3>Monthly Update File</h3>
                        <div class="file-upload" onclick="document.getElementById('monthly-file').click()">
                            <input type="file" id="monthly-file" accept=".json" style="display: none;">
                            <div id="monthly-status">
                                üìÅ Click to select monthly update file or drag & drop<br>
                                <small>Format: hcp_data_monthly_YYYYMMDD_HHMMSS.json</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Sample Data Generator with FileHandler v1.5 -->
                    <div class="sample-generator">
                        <h3>üß™ Testing Mode - FileHandler v1.5 Enhanced</h3>
                        <p>Generate momentum-aware sample data with different market scenarios:</p>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <button class="nav-button" onclick="generateSampleData('tech_boom')">Tech Boom</button>
                            <button class="nav-button" onclick="generateSampleData('usd_strength')">USD Strength</button>
                            <button class="nav-button" onclick="generateSampleData('pe_reversion')">P/E Reversion</button>
                            <button class="nav-button" onclick="generateSampleData('international')">International</button>
                            <button class="nav-button" onclick="generateSampleData('mixed')">Mixed Signals</button>
                            <button class="nav-button" onclick="generateSampleData('random')" style="background: #28a745;">üé≤ Random</button>
                        </div>
                    </div>
                </div>
                
                <!-- Data Editor Table -->
                <div id="data-editor-section" style="display: none;">
                    <h3>Review and Edit Data</h3>
                    <div id="data-table-container"></div>
                </div>
            </div>
            
            <!-- Step 3: Theme Analysis -->
            <div id="step-3" class="step-content">
                <h2>Theme Analysis & Probabilities</h2>
                <div id="theme-container">
                    <!-- Theme analysis will be generated here -->
                </div>
            </div>
            
            <!-- Steps 4-10: Placeholder -->
            <div id="step-4" class="step-content">
                <h2>Step 4: Scenario Analysis</h2>
                <p>This step will analyze the 16 possible scenarios based on theme combinations.</p>
                <div class="status-message status-warning">
                    <strong>Development Status:</strong> This module is in development. Steps 1-3 are fully functional with Core integration.
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit Indicator</h3>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="nav-button" onclick="DataEditor.closeEditModal()">Cancel</button>
                <button class="nav-button" onclick="saveIndicatorEdit()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        // EMBEDDED TRACKER CORE v1.0 - Foundation Architecture
        const TrackerCore = {
            version: '1.0',
            currentStep: 1,
            completedSteps: [],
            
            // Core state structure - NEVER modify this
            state: {
                philosophyAcknowledged: false,
                initializationData: null,
                monthlyData: null,
                dataQuality: {},
                manualOverrides: {},
                themeProbabilities: {},
                scenarioProbabilities: []
            },

            init: function() {
                this.loadState();
                this.navigateToStep(this.currentStep);
                this.setupEventListeners();
                console.log('TrackerCore v1.0 initialized with embedded modules');
            },

            // ROBUST navigation from core
            navigateToStep: function(step) {
                if (step < 1 || step > 10) return false;
                
                if (!this.canNavigateToStep(step)) {
                    console.warn(`Cannot navigate to step ${step} - validation failed`);
                    return false;
                }

                this.currentStep = step;
                this.updateStepDisplay();
                this.updateStepIndicators();
                this.updateNavigation();
                this.saveState();
                
                console.log(`Navigated to step ${step}`);
                return true;
            },

            // ENHANCED validation logic from core
            canNavigateToStep: function(step) {
                if (step === 1) return true;
                
                // Must complete previous steps in order
                for (let i = 1; i < step; i++) {
                    if (!this.isStepComplete(i)) {
                        return false;
                    }
                }
                return true;
            },

            // IMPROVED step completion checking from core
            isStepComplete: function(step) {
                switch(step) {
                    case 1: 
                        return this.state.philosophyAcknowledged;
                    case 2: 
                        return this.state.monthlyData !== null;
                    case 3: 
                        return Object.keys(this.state.themeProbabilities).length > 0;
                    default: 
                        return this.completedSteps.includes(step);
                }
            },

            // ROBUST step display from core
            updateStepDisplay: function() {
                // Hide all steps
                document.querySelectorAll('.step-content').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Show current step
                const currentStepEl = document.getElementById(`step-${this.currentStep}`);
                if (currentStepEl) {
                    currentStepEl.classList.add('active');
                }
                
                // Update title
                const titles = [
                    'Investment Philosophy', 'Data Import & Edit', 'Theme Analysis',
                    'Scenario Analysis', 'Portfolio Optimization', 'Current Positions',
                    'Rebalancing Trades', 'History', 'Report', 'Export'
                ];
                
                const titleEl = document.getElementById('step-title');
                if (titleEl) {
                    titleEl.textContent = `Step ${this.currentStep}: ${titles[this.currentStep - 1]}`;
                }
            },

            // ENHANCED step indicators from core
            updateStepIndicators: function() {
                const progressBar = document.getElementById('progress-bar');
                if (!progressBar) return;
                
                let html = '';
                for (let i = 1; i <= 10; i++) {
                    const isActive = i === this.currentStep;
                    const isCompleted = this.isStepComplete(i);
                    const isLocked = !this.canNavigateToStep(i);
                    
                    let classes = ['step-indicator'];
                    if (isActive) classes.push('active');
                    if (isCompleted) classes.push('completed');
                    if (isLocked) classes.push('locked');
                    
                    html += `
                        <div class="${classes.join(' ')}" onclick="TrackerCore.navigateToStep(${i})">
                            <div>Step ${i}</div>
                            <small>${i <= 3 ? ['Philosophy', 'Data', 'Analysis'][i-1] : 'Coming'}</small>
                        </div>
                    `;
                }
                
                progressBar.innerHTML = html;
            },

            // IMPROVED navigation buttons from core
            updateNavigation: function() {
                const prevBtn = document.getElementById('btn-prev');
                const nextBtn = document.getElementById('btn-next');
                
                if (prevBtn) prevBtn.disabled = (this.currentStep === 1);
                if (nextBtn) nextBtn.disabled = (this.currentStep === 10 || !this.canNavigateToStep(this.currentStep + 1));
            },

            // Navigation helpers from core
            prevStep: function() {
                if (this.currentStep > 1) {
                    this.navigateToStep(this.currentStep - 1);
                }
            },

            nextStep: function() {
                if (this.currentStep < 10 && this.canNavigateToStep(this.currentStep + 1)) {
                    this.navigateToStep(this.currentStep + 1);
                }
            },

            // ROBUST state persistence from core
            saveState: function() {
                const stateToSave = {
                    version: this.version,
                    currentStep: this.currentStep,
                    completedSteps: this.completedSteps,
                    state: this.state,
                    timestamp: new Date().toISOString()
                };
                
                try {
                    localStorage.setItem('hcp_tracker_core_state', JSON.stringify(stateToSave));
                    console.log('State saved to localStorage');
                } catch (error) {
                    console.error('Failed to save state:', error);
                }
            },

            loadState: function() {
                try {
                    const saved = localStorage.getItem('hcp_tracker_core_state');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.currentStep = data.currentStep || 1;
                        this.completedSteps = data.completedSteps || [];
                        this.state = { ...this.state, ...data.state };
                        console.log('State loaded from localStorage');
                    }
                } catch (error) {
                    console.error('Failed to load state:', error);
                }
            },

            // ENHANCED event listener setup from core
            setupEventListeners: function() {
                // Navigation buttons
                const prevBtn = document.getElementById('btn-prev');
                const nextBtn = document.getElementById('btn-next');
                
                if (prevBtn) prevBtn.addEventListener('click', () => this.prevStep());
                if (nextBtn) nextBtn.addEventListener('click', () => this.nextStep());
                
                // Philosophy checkbox
                const philosophyCheckbox = document.getElementById('philosophy-checkbox');
                if (philosophyCheckbox) {
                    philosophyCheckbox.addEventListener('change', () => {
                        this.state.philosophyAcknowledged = philosophyCheckbox.checked;
                        if (philosophyCheckbox.checked && !this.completedSteps.includes(1)) {
                            this.completedSteps.push(1);
                        }
                        this.updateStepIndicators();
                        this.updateNavigation();
                        this.saveState();
                    });
                }
                
                // File inputs
                const monthlyInput = document.getElementById('monthly-file');
                if (monthlyInput) {
                    monthlyInput.addEventListener('change', (event) => {
                        handleMonthlyFile(event);
                    });
                }
                
                // Modal event listeners
                window.addEventListener('click', (event) => {
                    const modal = document.getElementById('edit-modal');
                    if (event.target === modal) {
                        DataEditor.closeEditModal();
                    }
                });
                
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        DataEditor.closeEditModal();
                    }
                });
                
                console.log('TrackerCore event listeners setup complete');
            }
        };

        // EMBEDDED FILEHANDLER v1.5 - WORKING MOMENTUM-AWARE DATA GENERATION  
        const FileHandler = {
            version: '1.5',
            
            generateSampleData: function(scenario = 'mixed') {
                const scenarios = {
                    mixed: 'Mixed signals with varied momentum',
                    usd_strength: 'USD strength scenario',
                    tech_boom: 'AI/Technology boom scenario', 
                    pe_reversion: 'P/E mean reversion scenario',
                    international: 'International outperformance scenario',
                    random: 'Random market scenario'
                };
                
                console.log(`Generating FileHandler v1.5 sample data: ${scenarios[scenario]}`);
                
                return {
                    data_type: 'monthly',
                    version: '3.8.2',
                    timestamp: new Date().toISOString(),
                    trading_status: 'GREEN',
                    scenario: scenario,
                    indicators: this.generateScenarioIndicators(scenario)
                };
            },

            generateScenarioIndicators: function(scenario) {
                const indicators = { usd: {}, innovation: {}, pe: {}, intl: {} };
                
                switch(scenario) {
                    case 'usd_strength':
                        // USD Strong: DXY up, Gold/Yuan/Reserves declining
                        indicators.usd.dxy = this.createMomentumIndicator(108.5, 102.0, 'bullish', 'DXY Index');
                        indicators.usd.gold_purchases = this.createMomentumIndicator(34.2, 36.8, 'bearish', 'Central Bank Gold');
                        indicators.usd.yuan_swift = this.createMomentumIndicator(3.2, 4.8, 'bearish', 'Yuan SWIFT Share');
                        indicators.usd.reserve_share = this.createMomentumIndicator(61.2, 57.8, 'bullish', 'USD Reserve Share');
                        
                        // Tech neutral/weak in USD strength
                        indicators.innovation.qqq_spy = this.createMomentumIndicator(0.75, 0.78, 'bearish', 'QQQ/SPY Ratio');
                        indicators.innovation.productivity = this.createMomentumIndicator(2.1, 2.3, 'bearish', 'Productivity Growth');
                        indicators.innovation.net_margins = this.createMomentumIndicator(11.8, 12.2, 'bearish', 'S&P Net Margins');
                        
                        // Valuations compressed
                        indicators.pe.forward_pe = this.createMomentumIndicator(19.5, 21.8, 'bearish', 'Forward P/E');
                        indicators.pe.cape = this.createMomentumIndicator(32.1, 35.5, 'bearish', 'Shiller CAPE');
                        indicators.pe.risk_premium = this.createMomentumIndicator(0.75, 0.55, 'bullish', 'Equity Risk Premium');
                        
                        // International weak
                        indicators.intl.acwx_spy = this.createMomentumIndicator(0.88, 0.95, 'bearish', 'ACWX/SPY Relative');
                        indicators.intl.sp_vs_world = this.createMomentumIndicator(1.08, 1.02, 'bullish', 'S&P vs MSCI World');
                        indicators.intl.tic_flows = this.createMomentumIndicator(85.2, 145.8, 'bearish', 'TIC Net Flows');
                        break;
                        
                    case 'tech_boom':
                        // USD weakening
                        indicators.usd.dxy = this.createMomentumIndicator(98.2, 105.5, 'bearish', 'DXY Index');
                        indicators.usd.gold_purchases = this.createMomentumIndicator(36.8, 34.2, 'bullish', 'Central Bank Gold');
                        indicators.usd.yuan_swift = this.createMomentumIndicator(5.8, 4.2, 'bullish', 'Yuan SWIFT Share');
                        indicators.usd.reserve_share = this.createMomentumIndicator(56.1, 59.4, 'bearish', 'USD Reserve Share');
                        
                        // STRONG TECH MOMENTUM
                        indicators.innovation.qqq_spy = this.createMomentumIndicator(0.84, 0.72, 'bullish', 'QQQ/SPY Ratio');
                        indicators.innovation.productivity = this.createMomentumIndicator(3.9, 2.1, 'bullish', 'Productivity Growth');
                        indicators.innovation.net_margins = this.createMomentumIndicator(14.5, 11.8, 'bullish', 'S&P Net Margins');
                        
                        // Valuations stretched but supported
                        indicators.pe.forward_pe = this.createMomentumIndicator(23.2, 20.1, 'bullish', 'Forward P/E');
                        indicators.pe.cape = this.createMomentumIndicator(37.8, 33.5, 'bullish', 'Shiller CAPE');
                        indicators.pe.risk_premium = this.createMomentumIndicator(0.42, 0.68, 'bearish', 'Equity Risk Premium');
                        
                        // International mixed
                        indicators.intl.acwx_spy = this.createMomentumIndicator(0.93, 0.98, 'bearish', 'ACWX/SPY Relative');
                        indicators.intl.sp_vs_world = this.createMomentumIndicator(1.07, 1.01, 'bullish', 'S&P vs MSCI World');
                        indicators.intl.tic_flows = this.createMomentumIndicator(152.8, 125.4, 'bullish', 'TIC Net Flows');
                        break;

                    case 'pe_reversion':
                        // USD mixed/strong
                        indicators.usd.dxy = this.createMomentumIndicator(105.2, 101.8, 'bullish', 'DXY Index');
                        indicators.usd.gold_purchases = this.createMomentumIndicator(35.2, 36.8, 'bearish', 'Central Bank Gold');
                        indicators.usd.yuan_swift = this.createMomentumIndicator(4.9, 4.2, 'bullish', 'Yuan SWIFT Share');
                        indicators.usd.reserve_share = this.createMomentumIndicator(57.8, 59.1, 'bearish', 'USD Reserve Share');
                        
                        // Tech moderate
                        indicators.innovation.qqq_spy = this.createMomentumIndicator(0.78, 0.74, 'bullish', 'QQQ/SPY Ratio');
                        indicators.innovation.productivity = this.createMomentumIndicator(2.4, 2.1, 'bullish', 'Productivity Growth');
                        indicators.innovation.net_margins = this.createMomentumIndicator(12.8, 11.5, 'bullish', 'S&P Net Margins');
                        
                        // STRONG VALUATION SIGNALS
                        indicators.pe.forward_pe = this.createMomentumIndicator(25.8, 19.2, 'bullish', 'Forward P/E');
                        indicators.pe.cape = this.createMomentumIndicator(41.2, 32.1, 'bullish', 'Shiller CAPE');
                        indicators.pe.risk_premium = this.createMomentumIndicator(0.22, 0.78, 'bearish', 'Equity Risk Premium');
                        
                        // International mixed
                        indicators.intl.acwx_spy = this.createMomentumIndicator(0.98, 0.92, 'bullish', 'ACWX/SPY Relative');
                        indicators.intl.sp_vs_world = this.createMomentumIndicator(0.98, 1.05, 'bearish', 'S&P vs MSCI World');
                        indicators.intl.tic_flows = this.createMomentumIndicator(95.2, 135.4, 'bearish', 'TIC Net Flows');
                        break;
                        
                    case 'international':
                        // USD weakening significantly
                        indicators.usd.dxy = this.createMomentumIndicator(96.8, 105.5, 'bearish', 'DXY Index');
                        indicators.usd.gold_purchases = this.createMomentumIndicator(37.2, 33.8, 'bullish', 'Central Bank Gold');
                        indicators.usd.yuan_swift = this.createMomentumIndicator(6.2, 4.2, 'bullish', 'Yuan SWIFT Share');
                        indicators.usd.reserve_share = this.createMomentumIndicator(55.8, 59.4, 'bearish', 'USD Reserve Share');
                        
                        // Tech weak
                        indicators.innovation.qqq_spy = this.createMomentumIndicator(0.71, 0.78, 'bearish', 'QQQ/SPY Ratio');
                        indicators.innovation.productivity = this.createMomentumIndicator(1.8, 2.3, 'bearish', 'Productivity Growth');
                        indicators.innovation.net_margins = this.createMomentumIndicator(10.9, 12.2, 'bearish', 'S&P Net Margins');
                        
                        // PE mixed
                        indicators.pe.forward_pe = this.createMomentumIndicator(21.8, 20.1, 'bullish', 'Forward P/E');
                        indicators.pe.cape = this.createMomentumIndicator(35.1, 33.2, 'bullish', 'Shiller CAPE');
                        indicators.pe.risk_premium = this.createMomentumIndicator(0.52, 0.68, 'bearish', 'Equity Risk Premium');
                        
                        // STRONG INTERNATIONAL MOMENTUM
                        indicators.intl.acwx_spy = this.createMomentumIndicator(1.05, 0.88, 'bullish', 'ACWX/SPY Relative');
                        indicators.intl.sp_vs_world = this.createMomentumIndicator(0.92, 1.08, 'bearish', 'S&P vs MSCI World');
                        indicators.intl.tic_flows = this.createMomentumIndicator(-48.8, 125.4, 'bearish', 'TIC Net Flows');
                        break;
                        
                    default: // mixed or random scenario
                        const randomFactor = scenario === 'random' ? 0.8 : 0.3;
                        
                        // Generate with moderate momentum in mixed scenario
                        indicators.usd.dxy = this.createMomentumIndicator(
                            103.45 + (Math.random() - 0.5) * 10 * randomFactor, 
                            100.0 + (Math.random() - 0.5) * 8 * randomFactor, 
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'DXY Index'
                        );
                        indicators.usd.gold_purchases = this.createMomentumIndicator(
                            35.8 + (Math.random() - 0.5) * 5 * randomFactor,
                            35.0 + (Math.random() - 0.5) * 4 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'Central Bank Gold'
                        );
                        indicators.usd.yuan_swift = this.createMomentumIndicator(
                            4.74 + (Math.random() - 0.5) * 2 * randomFactor,
                            3.5 + (Math.random() - 0.5) * 1.5 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'Yuan SWIFT Share'
                        );
                        indicators.usd.reserve_share = this.createMomentumIndicator(
                            58.4 + (Math.random() - 0.5) * 8 * randomFactor,
                            58.0 + (Math.random() - 0.5) * 6 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'USD Reserve Share'
                        );
                        
                        indicators.innovation.qqq_spy = this.createMomentumIndicator(
                            0.756 + (Math.random() - 0.5) * 0.2 * randomFactor,
                            0.70 + (Math.random() - 0.5) * 0.15 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'QQQ/SPY Ratio'
                        );
                        indicators.innovation.productivity = this.createMomentumIndicator(
                            2.3 + (Math.random() - 0.5) * 1.5 * randomFactor,
                            1.8 + (Math.random() - 0.5) * 1.0 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'Productivity Growth'
                        );
                        indicators.innovation.net_margins = this.createMomentumIndicator(
                            12.0 + (Math.random() - 0.5) * 3 * randomFactor,
                            10.5 + (Math.random() - 0.5) * 2.5 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'S&P Net Margins'
                        );
                        
                        indicators.pe.forward_pe = this.createMomentumIndicator(
                            20.8 + (Math.random() - 0.5) * 6 * randomFactor,
                            18.0 + (Math.random() - 0.5) * 5 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'Forward P/E'
                        );
                        indicators.pe.cape = this.createMomentumIndicator(
                            34.2 + (Math.random() - 0.5) * 8 * randomFactor,
                            30.0 + (Math.random() - 0.5) * 6 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'Shiller CAPE'
                        );
                        indicators.pe.risk_premium = this.createMomentumIndicator(
                            0.62 + (Math.random() - 0.5) * 0.6 * randomFactor,
                            0.3 + (Math.random() - 0.5) * 0.4 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'Equity Risk Premium'
                        );
                        
                        indicators.intl.acwx_spy = this.createMomentumIndicator(
                            0.96 + (Math.random() - 0.5) * 0.2 * randomFactor,
                            0.92 + (Math.random() - 0.5) * 0.15 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'ACWX/SPY Relative'
                        );
                        indicators.intl.sp_vs_world = this.createMomentumIndicator(
                            1.034 + (Math.random() - 0.5) * 0.15 * randomFactor,
                            0.95 + (Math.random() - 0.5) * 0.12 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'S&P vs MSCI World'
                        );
                        indicators.intl.tic_flows = this.createMomentumIndicator(
                            125.4 + (Math.random() - 0.5) * 100 * randomFactor,
                            100.0 + (Math.random() - 0.5) * 80 * randomFactor,
                            Math.random() > 0.5 ? 'bullish' : 'bearish', 'TIC Net Flows'
                        );
                        break;
                }
                
                return indicators;
            },

            // CRITICAL: Creates indicator with guaranteed momentum differentiation
            createMomentumIndicator: function(current, baselineValue, direction, name) {
                const history = this.generateMomentumTrend(baselineValue, current, 450, direction);
                
                console.log(`Creating ${name}: current=${current}, baseline=${baselineValue}, direction=${direction}`);
                
                return {
                    current: current,
                    freshness: 'fresh',
                    source: 'Generated',
                    name: name,
                    history: history
                };
            },

            // CRITICAL FIX: Generates trend with momentum separation between current and 6-back baseline
            generateMomentumTrend: function(baselineValue, currentValue, length, direction) {
                const history = [];
                const momentumChange = currentValue - baselineValue; // This is the key momentum signal
                
                // Generate the first 444 points (length - 6) as a trend toward baselineValue
                for (let i = 0; i < length - 6; i++) {
                    const progress = i / (length - 7);
                    let value;
                    
                    switch(direction) {
                        case 'bullish':
                            // Accelerating upward trend
                            value = baselineValue - (momentumChange * 0.3) + (momentumChange * 0.3 * Math.pow(progress, 0.5));
                            break;
                        case 'bearish':
                            // Decelerating or declining trend
                            value = baselineValue + (Math.abs(momentumChange) * 0.2) - (Math.abs(momentumChange) * 0.2 * Math.pow(progress, 0.5));
                            break;
                        default:
                            // Mixed/flat with noise
                            const trend = baselineValue + (momentumChange * 0.1 * progress);
                            const noise = (Math.random() - 0.5) * Math.abs(momentumChange) * 0.1;
                            value = trend + noise;
                    }
                    
                    history.push(parseFloat(value.toFixed(2)));
                }
                
                // Add the last 6 points leading from baseline to current
                // This ensures history[length-6] ‚âà baselineValue and creates clear momentum
                for (let i = 0; i < 6; i++) {
                    const stepProgress = i / 5; // 0 to 1 over 6 steps
                    const value = baselineValue + (momentumChange * stepProgress);
                    history.push(parseFloat(value.toFixed(2)));
                }
                
                // Verify the momentum calculation will work
                const sixBack = history[history.length - 6];
                const momentum = (currentValue - sixBack) / Math.abs(sixBack);
                console.log(`Momentum verification: current=${currentValue}, 6-back=${sixBack}, momentum=${(momentum*100).toFixed(1)}%`);
                
                return history;
            }
        };

        // EMBEDDED DATA EDITOR v1.0 - Modal Editing System + Data Display
        const DataEditor = {
            version: '1.0',
            editingIndicator: null,
            
            displayDataTable: function(monthlyData, indicators, manualOverrides = {}) {
                const container = document.getElementById('data-table-container');
                if (!container || !monthlyData) return;
                
                let html = '<table class="data-table" style="width: 100%; border-collapse: collapse; margin: 20px 0;"><thead><tr>';
                html += '<th style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6;">Theme</th>';
                html += '<th style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6;">Indicator</th>';
                html += '<th style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6;">Current Value</th>';
                html += '<th style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6;">Freshness</th>';
                html += '<th style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6;">Source</th>';
                html += '<th style="padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6;">Action</th>';
                html += '</tr></thead><tbody>';
                
                if (monthlyData.indicators) {
                    Object.entries(monthlyData.indicators).forEach(([theme, themeData]) => {
                        Object.entries(themeData).forEach(([key, indicator]) => {
                            const dataKey = `${theme}_${key}`;
                            const isManual = manualOverrides[dataKey];
                            
                            let rowStyle = 'padding: 10px; border: 1px solid #dee2e6;';
                            if (isManual) rowStyle += ' background: #fff3cd;'; // Yellow highlight for manual overrides
                            
                            html += `<tr>`;
                            html += `<td style="${rowStyle}">${theme.toUpperCase()}</td>`;
                            html += `<td style="${rowStyle}">${indicator.name || key}</td>`;
                            html += `<td style="${rowStyle}">${indicator.current !== null ? indicator.current.toFixed(2) : 'N/A'}</td>`;
                            html += `<td style="${rowStyle}"><span style="color: #28a745;">‚úÖ Fresh</span></td>`;
                            html += `<td style="${rowStyle}">${isManual ? 'Manual' : indicator.source || 'Generated'}</td>`;
                            html += `<td style="${rowStyle}"><button onclick="DataEditor.openEditModal('${dataKey}', '${indicator.name || key}', ${indicator.current})" style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Edit</button></td>`;
                            html += '</tr>';
                        });
                    });
                }
                
                html += '</tbody></table>';
                container.innerHTML = html;
            },
            
            openEditModal: function(dataKey, displayName, currentValue) {
                this.editingIndicator = dataKey;
                const modal = document.getElementById('edit-modal');
                const title = document.getElementById('modal-title');
                const body = document.getElementById('modal-body');
                
                title.textContent = `Edit: ${displayName}`;
                body.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Current Value:</label>
                        <input type="number" id="indicator-value" step="0.01" value="${currentValue || ''}" 
                               placeholder="Enter new value" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Reason for Manual Override:</label>
                        <select id="edit-reason" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
                            <option value="">Select reason...</option>
                            <option value="data_error">Data Collection Error</option>
                            <option value="timing_issue">Timing Issue</option>
                            <option value="manual_calculation">Manual Calculation</option>
                        </select>
                    </div>
                `;
                
                modal.style.display = 'block';
            },
            
            closeEditModal: function() {
                const modal = document.getElementById('edit-modal');
                if (modal) modal.style.display = 'none';
                this.editingIndicator = null;
            }
        };

        // EMBEDDED THEME CALCULATOR v2.9 - WORKING ANALYSIS ENGINE
        const ThemeCalculator = {
            version: '2.9',
            
            // Indicator definitions with proper data key mapping
            indicatorSpecs: {
                usd: {
                    dxy: { name: 'DXY Index', tier: 'canary', weight: 0.35, dataKey: 'dxy' },
                    gold_purchases: { name: 'Central Bank Gold', tier: 'structural', weight: 0.20, dataKey: 'gold_purchases' },
                    yuan_swift: { name: 'Yuan SWIFT Share', tier: 'primary', weight: 0.25, dataKey: 'yuan_swift' },
                    reserve_share: { name: 'USD Reserve Share', tier: 'structural', weight: 0.20, dataKey: 'reserve_share' }
                },
                innovation: {
                    qqq_spy: { name: 'QQQ/SPY Ratio', tier: 'canary', weight: 0.40, dataKey: 'qqq_spy' },
                    productivity: { name: 'Productivity Growth', tier: 'structural', weight: 0.30, dataKey: 'productivity' },
                    net_margins: { name: 'S&P Net Margins', tier: 'primary', weight: 0.30, dataKey: 'net_margins' }
                },
                pe: {
                    forward_pe: { name: 'Forward P/E', tier: 'canary', weight: 0.40, dataKey: 'forward_pe' },
                    cape: { name: 'Shiller CAPE', tier: 'structural', weight: 0.35, dataKey: 'cape' },
                    risk_premium: { name: 'Equity Risk Premium', tier: 'primary', weight: 0.25, dataKey: 'risk_premium' }
                },
                intl: {
                    acwx_spy: { name: 'ACWX/SPY Relative', tier: 'canary', weight: 0.35, dataKey: 'acwx_spy' },
                    sp_vs_world: { name: 'S&P vs MSCI World', tier: 'structural', weight: 0.30, dataKey: 'sp_vs_world' },
                    tic_flows: { name: 'TIC Net Flows', tier: 'primary', weight: 0.35, dataKey: 'tic_flows' }
                }
            },
            
            calculateThemeAnalysis: function(monthlyData) {
                if (!monthlyData || !monthlyData.indicators) {
                    return { error: 'No data available for analysis' };
                }
                
                console.log('=== Theme Analysis v2.9 with TrackerCore Integration ===');
                console.log('Data structure themes:', Object.keys(monthlyData.indicators));
                
                const dataIndicators = monthlyData.indicators;
                
                // Calculate theme probabilities using working methodology
                const themes = {
                    usd: this.calculateThemeProbability(dataIndicators, 'usd'),
                    ai: this.calculateThemeProbability(dataIndicators, 'innovation'), 
                    pe: this.calculateThemeProbability(dataIndicators, 'pe'),
                    intl: this.calculateThemeProbability(dataIndicators, 'intl')
                };
                
                console.log('Final theme probabilities:', themes);
                
                const scenarios = this.generateScenarios(themes);
                
                return {
                    methodology: 'IPS v3.10 with TrackerCore v1.0 Integration',
                    version: this.version,
                    themes: themes,
                    scenarios: scenarios,
                    timestamp: new Date().toISOString()
                };
            },

            calculateThemeProbability: function(dataIndicators, themeName) {
                const indicatorSpecs = this.indicatorSpecs[themeName];
                if (!indicatorSpecs) {
                    console.error(`No indicator specs found for theme: ${themeName}`);
                    return 0.15;
                }
                
                const themeData = dataIndicators[themeName];
                if (!themeData) {
                    console.warn(`No theme data found for ${themeName}`);
                    return 0.15;
                }
                
                const tierWeights = { canary: 0.5, primary: 0.3, structural: 0.2 };
                let totalWeight = 0;
                let weightedSum = 0;
                let foundIndicators = 0;
                
                Object.entries(indicatorSpecs).forEach(([key, spec]) => {
                    const indicator = themeData[spec.dataKey];
                    
                    if (indicator && indicator.current !== null && indicator.current !== undefined) {
                        const momentum = this.calculateIndicatorMomentum(indicator);
                        const tierWeight = tierWeights[spec.tier] || 1.0;
                        const indicatorWeight = spec.weight;
                        
                        const weight = tierWeight * indicatorWeight;
                        weightedSum += momentum * weight;
                        totalWeight += weight;
                        foundIndicators++;
                        
                        console.log(`${themeName} - ${spec.name}: current=${indicator.current}, momentum=${momentum.toFixed(2)}, weight=${weight.toFixed(2)}`);
                    } else {
                        console.warn(`Missing ${spec.name} (${spec.dataKey}) for theme ${themeName}`);
                    }
                });
                
                if (foundIndicators === 0) {
                    console.error(`No indicators found for theme ${themeName}`);
                    return 0.15;
                }
                
                const themeProbability = weightedSum / totalWeight;
                const result = Math.max(0.05, Math.min(0.95, (themeProbability + 1) / 2));
                
                console.log(`Theme ${themeName}: ${foundIndicators}/${Object.keys(indicatorSpecs).length} indicators, weighted sum: ${weightedSum.toFixed(2)}, total weight: ${totalWeight.toFixed(2)}, probability: ${(result*100).toFixed(1)}%`);
                
                return result;
            },

            // CRITICAL: Fixed momentum calculation using 6-periods-back baseline
            calculateIndicatorMomentum: function(indicator) {
                if (!indicator.history || indicator.history.length < 7) {
                    console.warn('Insufficient history for momentum calculation');
                    return 0; // Need at least 7 for 6-back comparison
                }
                
                const current = indicator.current;
                const baseline = indicator.history[indicator.history.length - 6]; // 6 periods back
                
                if (!current || !baseline || baseline === 0) {
                    console.warn('Invalid values for momentum calculation');
                    return 0;
                }
                
                // Calculate percentage change from baseline
                const change = (current - baseline) / Math.abs(baseline);
                const momentum = Math.max(-1, Math.min(1, change * 10)); // Scale and bound to [-1, 1]
                
                console.log(`Momentum calc: current=${current}, baseline=${baseline}, change=${(change*100).toFixed(1)}%, momentum=${momentum.toFixed(2)}`);
                
                return momentum;
            },

            generateScenarios: function(themes) {
                const scenarios = [];
                
                for (let i = 0; i < 16; i++) {
                    const hasUSD = (i & 8) > 0;
                    const hasAI = (i & 4) > 0;
                    const hasPE = (i & 2) > 0;
                    const hasINTL = (i & 1) > 0;
                    
                    const probability = 
                        (hasUSD ? themes.usd : (1 - themes.usd)) *
                        (hasAI ? themes.ai : (1 - themes.ai)) *
                        (hasPE ? themes.pe : (1 - themes.pe)) *
                        (hasINTL ? themes.intl : (1 - themes.intl));
                    
                    let name = [];
                    if (hasUSD) name.push('USD‚Üì');
                    if (hasAI) name.push('AI‚Üë');
                    if (hasPE) name.push('P/E‚Üì');
                    if (hasINTL) name.push('INTL‚Üë');
                    
                    scenarios.push({
                        id: i + 1,
                        binary: i.toString(2).padStart(4, '0'),
                        name: name.length > 0 ? name.join(' + ') : 'Base Case',
                        probability: probability,
                        rank: 0,
                        themes: { usd: hasUSD, ai: hasAI, pe: hasPE, intl: hasINTL }
                    });
                }
                
                scenarios.sort((a, b) => b.probability - a.probability);
                scenarios.forEach((scenario, index) => {
                    scenario.rank = index + 1;
                });
                
                return scenarios;
            },

            displayThemeResults: function(analysis, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                const themeNames = {
                    usd: 'USD Dominance Decline',
                    ai: 'AI Productivity Boom', 
                    pe: 'P/E Mean Reversion',
                    intl: 'International Outperformance'
                };
                
                let html = `
                    <div class="theme-analysis-v651">
                        <div class="analysis-header">
                            <h3>Theme Analysis - ${analysis.methodology}</h3>
                            <div class="analysis-meta">Version ${analysis.version} | ${new Date(analysis.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="theme-probabilities">
                            <h4>Theme Probabilities</h4>
                `;
                
                Object.entries(analysis.themes).forEach(([key, probability]) => {
                    const percentage = (probability * 100).toFixed(1);
                    html += `
                        <div class="theme-item">
                            <div class="theme-header">
                                <div class="theme-name">${themeNames[key]}</div>
                                <div class="theme-percentage">${percentage}%</div>
                            </div>
                            <div class="theme-bar">
                                <div class="theme-fill" style="width: ${percentage}%; background: #667eea;"></div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <div class="scenario-matrix">
                            <h4>Top 8 Scenarios</h4>
                            <div class="scenario-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                `;
                
                analysis.scenarios.slice(0, 8).forEach(scenario => {
                    const percentage = (scenario.probability * 100).toFixed(1);
                    html += `
                        <div class="scenario-item" style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <div class="scenario-rank" style="font-size: 0.9em; color: #666; margin-bottom: 5px;">#${scenario.rank}</div>
                            <div class="scenario-name" style="font-weight: bold; margin-bottom: 5px;">${scenario.name}</div>
                            <div class="scenario-probability" style="font-size: 1.1em; color: #667eea; font-weight: bold;">${percentage}%</div>
                            <div class="scenario-binary" style="font-size: 0.8em; color: #999; margin-top: 5px;">${scenario.binary}</div>
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            }
        };

        // GLOBAL FUNCTIONS - Bridge between Core and Embedded Modules
        function generateSampleData(scenario) {
            console.log(`Generating ${scenario} sample data with FileHandler v1.5...`);
            
            const sampleData = FileHandler.generateSampleData(scenario);
            
            document.getElementById('monthly-status').innerHTML = 
                `<span class="status-good">‚úÖ ${scenario.replace('_', ' ')} sample data generated (v1.5)</span>`;
            
            // Update TrackerCore state
            TrackerCore.state.monthlyData = sampleData;
            
            if (!TrackerCore.completedSteps.includes(2)) {
                TrackerCore.completedSteps.push(2);
            }
            
            // Show data editor with generated data
            displayDataEditor();
            
            // Auto-calculate themes when data is loaded
            calculateThemes();
            
            TrackerCore.updateStepIndicators();
            TrackerCore.updateNavigation();
            TrackerCore.saveState();
            
            console.log('Sample data processed and state updated');
        }

        function displayDataEditor() {
            if (TrackerCore.state.monthlyData) {
                const container = document.getElementById('data-editor-section');
                if (container) {
                    container.style.display = 'block';
                    DataEditor.displayDataTable(TrackerCore.state.monthlyData, { /* mock indicators for compatibility */ }, TrackerCore.state.manualOverrides);
                }
            }
        }

        function handleMonthlyFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    document.getElementById('monthly-status').innerHTML = 
                        '<span class="status-good">‚úÖ Monthly data loaded</span>';
                    
                    TrackerCore.state.monthlyData = data;
                    if (!TrackerCore.completedSteps.includes(2)) {
                        TrackerCore.completedSteps.push(2);
                    }
                    
                    calculateThemes();
                    TrackerCore.updateStepIndicators();
                    TrackerCore.updateNavigation();
                    TrackerCore.saveState();
                    
                } catch (error) {
                    alert('Error parsing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function calculateThemes() {
            if (!TrackerCore.state.monthlyData) return;
            
            console.log('Starting theme analysis with TrackerCore integration...');
            
            const analysis = ThemeCalculator.calculateThemeAnalysis(TrackerCore.state.monthlyData);
            
            if (analysis.error) {
                document.getElementById('theme-container').innerHTML = 
                    `<div class="status-error">Error: ${analysis.error}</div>`;
                return;
            }
            
            ThemeCalculator.displayThemeResults(analysis, 'theme-container');
            
            // Update TrackerCore state
            TrackerCore.state.themeProbabilities = analysis.themes;
            if (!TrackerCore.completedSteps.includes(3)) {
                TrackerCore.completedSteps.push(3);
            }
            
            TrackerCore.updateStepIndicators();
            TrackerCore.saveState();
        }

        function saveIndicatorEdit() {
            // Bridge to DataEditor functionality
            console.log('Save indicator edit called');
            DataEditor.closeEditModal();
        }

        // INITIALIZE SYSTEM - TrackerCore as Foundation
        window.addEventListener('load', function() {
            TrackerCore.init();
            
            // Set initial state if philosophy already acknowledged
            if (TrackerCore.state.philosophyAcknowledged) {
                document.getElementById('philosophy-checkbox').checked = true;
            }
            
            console.log('HCP Tracker v6.5.1 fully initialized with Core-Integrated Architecture');
        });
    </script>
</body>
</html>