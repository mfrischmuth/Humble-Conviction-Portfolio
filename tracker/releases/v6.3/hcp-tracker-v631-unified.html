<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCP Portfolio Tracker v6.3.1 - Unified Features</title>
    <!--
    HCP PORTFOLIO TRACKER v6.3.1 - UNIFIED FEATURES RELEASE
    File: hcp_tracker_v6.3.1_unified.html
    Last Updated: 2025-08-27 15:00:00 UTC
    Author: Synthesized from v6.0, v6.2, v6.3
    Status: Combines all features from previous versions
    
    FEATURES INCLUDED:
    - From v6.0: Complete data editing system with modal
    - From v6.2: Three-tier framework, sample data generator
    - From v6.3: Enhanced visualization with arrows
    - IPS v3.9 compliant: 13 indicators (removed dxyLevel)
    
    VERSION HISTORY:
    - v6.3.1 (2025-08-27): Unified all features
      * Restored data editing from v6.0
      * Maintained three-tier framework from v6.2
      * Kept enhanced visualizations from v6.3
      * Verified 13 indicators per IPS v3.9
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .version-info {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        /* Progress Bar */
        .progress-bar {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .step-indicator {
            flex: 1;
            min-width: 80px;
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step-indicator.completed {
            background: rgba(255,255,255,0.3);
        }
        
        .step-indicator.active {
            background: #ffc107;
            color: #333;
        }
        
        .step-indicator.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Navigation */
        .navigation {
            background: #f8f9fa;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dee2e6;
        }
        
        .nav-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .nav-button:hover:not(:disabled) {
            background: #5a67d8;
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Content Area */
        .content {
            padding: 30px;
            min-height: 400px;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
        }
        
        /* Philosophy Step (Step 1) */
        .philosophy-content {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.8;
        }
        
        .philosophy-intro {
            background: #f0f4ff;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        .philosophy-section {
            margin-bottom: 25px;
        }
        
        .philosophy-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .philosophy-section ul {
            list-style-position: inside;
            margin-left: 20px;
        }
        
        .philosophy-section li {
            margin-bottom: 10px;
        }
        
        .acknowledgment {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }
        
        /* Data Import Step (Step 2) */
        .data-section {
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        
        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            background: #f0f4ff;
        }
        
        .file-upload.drag-over {
            background: #f0f4ff;
            border-color: #5a67d8;
        }
        
        .sample-generator {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffc107;
        }
        
        /* Data Table (FROM v6.0) */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border: 1px solid #dee2e6;
        }
        
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .data-table tr.manual-override {
            background: #fff3cd !important;
        }
        
        .edit-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .edit-button:hover {
            background: #5a67d8;
        }
        
        /* Edit Modal (FROM v6.0) */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Theme Analysis Step (Step 3) */
        .theme-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .theme-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .theme-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .theme-probability {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        
        .indicator-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .indicator-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }
        
        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .indicator-name {
            font-weight: 600;
            color: #333;
        }
        
        .indicator-value {
            font-weight: bold;
            color: #667eea;
        }
        
        .tier-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .tier-canary {
            background: #ffebee;
            color: #c62828;
        }
        
        .tier-primary {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .tier-structural {
            background: #f3e5f5;
            color: #6a1b9a;
        }
        
        /* Arrow Visualization (FROM v6.3) */
        .indicator-bar {
            height: 30px;
            background: #e9ecef;
            border-radius: 4px;
            position: relative;
            margin: 10px 0;
            overflow: visible;
        }
        
        .indicator-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.5s ease;
        }
        
        .arrow-body {
            height: 4px;
            background: #667eea;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .arrow-head {
            width: 0;
            height: 0;
            border-style: solid;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .arrow-positive .arrow-body {
            background: #28a745;
        }
        
        .arrow-positive .arrow-head {
            border-color: transparent transparent transparent #28a745;
        }
        
        .arrow-negative .arrow-body {
            background: #dc3545;
        }
        
        .arrow-negative .arrow-head {
            border-color: transparent #dc3545 transparent transparent;
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .status-good {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>HCP Portfolio Tracker v6.3.1</h1>
            <div class="version-info">
                Unified Features Release | IPS v3.9 Compliant (13 Indicators) | Data Collector v3.8.0+
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="step-indicator active" onclick="tracker.navigateToStep(1)">
                <div>Step 1</div>
                <small>Philosophy</small>
            </div>
            <div class="step-indicator" onclick="tracker.navigateToStep(2)">
                <div>Step 2</div>
                <small>Data</small>
            </div>
            <div class="step-indicator" onclick="tracker.navigateToStep(3)">
                <div>Step 3</div>
                <small>Analysis</small>
            </div>
            <div class="step-indicator locked">
                <div>Step 4</div>
                <small>Scenarios</small>
            </div>
            <div class="step-indicator locked">
                <div>Step 5</div>
                <small>Optimize</small>
            </div>
            <div class="step-indicator locked">
                <div>Step 6</div>
                <small>Positions</small>
            </div>
            <div class="step-indicator locked">
                <div>Step 7</div>
                <small>Rebalance</small>
            </div>
            <div class="step-indicator locked">
                <div>Step 8</div>
                <small>History</small>
            </div>
            <div class="step-indicator locked">
                <div>Step 9</div>
                <small>Report</small>
            </div>
            <div class="step-indicator locked">
                <div>Step 10</div>
                <small>Export</small>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-button" id="prev-button" onclick="tracker.previousStep()" disabled>← Previous</button>
            <div id="step-title">Step 1: Investment Philosophy</div>
            <button class="nav-button" id="next-button" onclick="tracker.nextStep()" disabled>Next →</button>
        </div>
        
        <!-- Content Area -->
        <div class="content">
            <!-- Step 1: Philosophy -->
            <div id="step-1" class="step-content active">
                <div class="philosophy-content">
                    <div class="philosophy-intro">
                        <h2>Welcome to the Humble Conviction Portfolio System</h2>
                        <p>This Investment Policy Statement outlines a systematic, probability-weighted approach to portfolio management based on macro regime analysis. The framework monitors 13 indicators across 4 themes to determine scenario probabilities and optimize allocation accordingly.</p>
                    </div>
                    
                    <div class="philosophy-section">
                        <h3>Core Innovation</h3>
                        <p>Rather than static allocation, the portfolio dynamically adjusts based on the probability-weighted expected outcomes across 16 possible macro scenarios, with risk minimization to protect against scenario divergence.</p>
                    </div>
                    
                    <div class="philosophy-section">
                        <h3>Core Beliefs</h3>
                        <ul>
                            <li>Markets are regime-dependent - Different macro environments require different exposures</li>
                            <li>Diversification across scenarios beats diversification within a single scenario</li>
                            <li>Risk management should focus on avoiding catastrophic outcomes in any probable scenario</li>
                            <li>Systematic beats discretionary - Rules-based approach removes emotional bias</li>
                            <li>Probability-weighted optimization captures uncertainty better than point forecasts</li>
                        </ul>
                    </div>
                    
                    <div class="philosophy-section">
                        <h3>Investment Objectives</h3>
                        <ul>
                            <li><strong>Primary:</strong> Achieve 8-12% annual returns across market cycles</li>
                            <li><strong>Secondary:</strong> Limit maximum drawdown to 15% in any 12-month period</li>
                            <li><strong>Tertiary:</strong> Maintain liquidity for opportunistic investments</li>
                        </ul>
                    </div>
                    
                    <div class="acknowledgment">
                        <label>
                            <input type="checkbox" id="philosophy-checkbox" onchange="tracker.acknowledgePhilosophy()">
                            <strong>I understand and acknowledge the investment philosophy</strong>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Data Import -->
            <div id="step-2" class="step-content">
                <div class="data-section">
                    <h2>Import Data Files</h2>
                    <p>The system requires two data files from the HCP Data Collector:</p>
                    
                    <!-- Initialization File -->
                    <div style="margin-bottom: 30px;">
                        <h3>1. Initialization File (One-Time Setup)</h3>
                        <p>Contains 24-36 months of historical data for baseline calculations</p>
                        <div class="file-upload" onclick="document.getElementById('init-file').click()">
                            <input type="file" id="init-file" accept=".json" style="display: none;" onchange="tracker.handleInitFile(event)">
                            <div id="init-status">
                                📁 Click to select initialization file or drag & drop<br>
                                <small>Format: hcp_data_initialize_YYYYMMDD_HHMMSS.json</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Update File -->
                    <div>
                        <h3>2. Monthly Update File</h3>
                        <p>Contains current indicator values and 6-month history</p>
                        <div class="file-upload" onclick="document.getElementById('monthly-file').click()">
                            <input type="file" id="monthly-file" accept=".json" style="display: none;" onchange="tracker.handleMonthlyFile(event)">
                            <div id="monthly-status">
                                📁 Click to select monthly update file or drag & drop<br>
                                <small>Format: hcp_data_monthly_YYYYMMDD_HHMMSS.json</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sample Data Generator -->
                    <div class="sample-generator">
                        <h3>🧪 Testing Mode</h3>
                        <p>Don't have data files? Generate sample data for testing:</p>
                        <button class="nav-button" onclick="tracker.generateSampleData()">Generate Sample Data</button>
                    </div>
                </div>
                
                <!-- Data Editor Table (FROM v6.0) -->
                <div id="data-editor-section" style="display: none;">
                    <h3>Review and Edit Data</h3>
                    <div id="data-table-container"></div>
                </div>
            </div>
            
            <!-- Step 3: Theme Analysis -->
            <div id="step-3" class="step-content">
                <h2>Theme Analysis & Probabilities</h2>
                <div id="theme-container">
                    <!-- Theme cards will be generated here -->
                </div>
                <div id="scenario-summary" style="margin-top: 30px;">
                    <!-- Scenario probabilities will be shown here -->
                </div>
            </div>
            
            <!-- Steps 4-10: Placeholder -->
            <div id="step-4" class="step-content">
                <h2>Step 4: Scenario Analysis</h2>
                <p>This step will analyze the 16 possible scenarios based on theme combinations.</p>
            </div>
            
            <div id="step-5" class="step-content">
                <h2>Step 5: Portfolio Optimization</h2>
                <p>This step will optimize the portfolio allocation based on scenario probabilities.</p>
            </div>
            
            <div id="step-6" class="step-content">
                <h2>Step 6: Current Positions</h2>
                <p>Enter your current portfolio positions.</p>
            </div>
            
            <div id="step-7" class="step-content">
                <h2>Step 7: Rebalancing Trades</h2>
                <p>Generate the trades needed to reach optimal allocation.</p>
            </div>
            
            <div id="step-8" class="step-content">
                <h2>Step 8: History</h2>
                <p>View historical changes and audit trail.</p>
            </div>
            
            <div id="step-9" class="step-content">
                <h2>Step 9: Report</h2>
                <p>Generate detailed analysis report.</p>
            </div>
            
            <div id="step-10" class="step-content">
                <h2>Step 10: Export</h2>
                <p>Export data and reports.</p>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal (FROM v6.0) -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit Indicator</h3>
                <button onclick="tracker.closeEditModal()" style="float: right;">×</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="nav-button" onclick="tracker.closeEditModal()">Cancel</button>
                <button class="nav-button" onclick="tracker.saveIndicatorEdit()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        // HCP Portfolio Tracker v6.3.1 - Unified JavaScript
        const tracker = {
            version: '6.3.1',
            currentStep: 1,
            completedSteps: [],
            editingIndicator: null,
            
            // State management
            state: {
                philosophyAcknowledged: false,
                initializationData: null,
                monthlyData: null,
                dataQuality: {},
                manualOverrides: {},
                themeProbabilities: {},
                scenarioProbabilities: []
            },
            
            // 13 Indicators per IPS v3.9 (removed dxyLevel)
            indicators: {
                usd: {
                    dxy: { name: 'DXY Index', tier: 'canary', weight: 0.35, trigger: 'MA' },
                    gold: { name: 'Central Bank Gold', tier: 'structural', weight: 0.20, trigger: 'MA' },
                    yuanSwift: { name: 'Yuan SWIFT Share', tier: 'primary', weight: 0.25, trigger: 'MA' },
                    reserveShare: { name: 'USD Reserve Share', tier: 'structural', weight: 0.20, trigger: 'YoY' }
                },
                innovation: {
                    qqqSpy: { name: 'QQQ/SPY Ratio', tier: 'canary', weight: 0.35, trigger: 'MA' },
                    productivity: { name: 'Productivity Growth', tier: 'primary', weight: 0.40, trigger: 'MA' },
                    netMargins: { name: 'S&P Net Margins', tier: 'structural', weight: 0.25, trigger: 'MA' }
                },
                pe: {
                    riskPremium: { name: 'Equity Risk Premium', tier: 'canary', weight: 0.30, trigger: 'MA' },
                    forwardPE: { name: 'Forward P/E', tier: 'primary', weight: 0.40, trigger: 'MA' },
                    cape: { name: 'Shiller CAPE', tier: 'primary', weight: 0.30, trigger: 'MA' }
                },
                international: {
                    acwxSpy: { name: 'ACWX/SPY Relative', tier: 'canary', weight: 0.35, trigger: 'MA' },
                    spVsWorld: { name: 'S&P vs MSCI World', tier: 'primary', weight: 0.35, trigger: '6M' },
                    usAcwi: { name: 'US % of ACWI', tier: 'primary', weight: 0.15, trigger: 'MA' },
                    ticFlows: { name: 'TIC Net Flows', tier: 'structural', weight: 0.15, trigger: 'Zero' }
                }
            },
            
            // Initialize
            init: function() {
                this.loadState();
                this.updateStepIndicators();
                this.updateNavigation();
            },
            
            // Step Navigation
            navigateToStep: function(step) {
                if (step < 1 || step > 10) return;
                if (!this.canNavigateToStep(step)) return;
                
                this.currentStep = step;
                this.updateStepDisplay();
                this.updateStepIndicators();
                this.updateNavigation();
                this.saveState();
            },
            
            canNavigateToStep: function(step) {
                if (step === 1) return true;
                if (step === 2) return this.state.philosophyAcknowledged;
                if (step === 3) return this.state.monthlyData !== null;
                if (step > 3) return this.completedSteps.includes(3);
                return false;
            },
            
            previousStep: function() {
                if (this.currentStep > 1) {
                    this.navigateToStep(this.currentStep - 1);
                }
            },
            
            nextStep: function() {
                if (this.currentStep < 10 && this.canNavigateToStep(this.currentStep + 1)) {
                    this.navigateToStep(this.currentStep + 1);
                }
            },
            
            updateStepDisplay: function() {
                // Hide all steps
                document.querySelectorAll('.step-content').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Show current step
                const currentStepEl = document.getElementById(`step-${this.currentStep}`);
                if (currentStepEl) {
                    currentStepEl.classList.add('active');
                }
                
                // Update title
                const titles = [
                    'Investment Philosophy',
                    'Data Import & Edit',
                    'Theme Analysis',
                    'Scenario Analysis',
                    'Portfolio Optimization',
                    'Current Positions',
                    'Rebalancing Trades',
                    'History',
                    'Report',
                    'Export'
                ];
                document.getElementById('step-title').textContent = `Step ${this.currentStep}: ${titles[this.currentStep - 1]}`;
            },
            
            updateStepIndicators: function() {
                document.querySelectorAll('.step-indicator').forEach((el, index) => {
                    const step = index + 1;
                    el.classList.remove('active', 'completed', 'locked');
                    
                    if (step === this.currentStep) {
                        el.classList.add('active');
                    } else if (this.completedSteps.includes(step)) {
                        el.classList.add('completed');
                    } else if (!this.canNavigateToStep(step)) {
                        el.classList.add('locked');
                    }
                });
            },
            
            updateNavigation: function() {
                const prevButton = document.getElementById('prev-button');
                const nextButton = document.getElementById('next-button');
                
                prevButton.disabled = this.currentStep === 1;
                
                if (this.currentStep === 1) {
                    nextButton.disabled = !this.state.philosophyAcknowledged;
                } else if (this.currentStep === 2) {
                    nextButton.disabled = !this.state.monthlyData;
                } else {
                    nextButton.disabled = !this.canNavigateToStep(this.currentStep + 1);
                }
            },
            
            // Step 1: Philosophy
            acknowledgePhilosophy: function() {
                const checkbox = document.getElementById('philosophy-checkbox');
                this.state.philosophyAcknowledged = checkbox.checked;
                
                if (checkbox.checked && !this.completedSteps.includes(1)) {
                    this.completedSteps.push(1);
                }
                
                this.updateNavigation();
                this.saveState();
            },
            
            // Step 2: Data Import
            handleInitFile: function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.state.initializationData = data;
                        document.getElementById('init-status').innerHTML = 
                            '<span class="status-good">✅ Initialization data loaded successfully</span>';
                        this.checkDataComplete();
                    } catch (error) {
                        alert('Error parsing initialization file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            },
            
            handleMonthlyFile: function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.state.monthlyData = data;
                        document.getElementById('monthly-status').innerHTML = 
                            '<span class="status-good">✅ Monthly data loaded successfully</span>';
                        this.checkDataComplete();
                    } catch (error) {
                        alert('Error parsing monthly file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            },
            
            checkDataComplete: function() {
                if (this.state.monthlyData) {
                    this.displayDataTable();
                    
                    if (!this.completedSteps.includes(2)) {
                        this.completedSteps.push(2);
                    }
                    
                    this.updateNavigation();
                    this.updateStepIndicators();
                    this.saveState();
                }
            },
            
            // Data Editor (FROM v6.0)
            displayDataTable: function() {
                const container = document.getElementById('data-table-container');
                const section = document.getElementById('data-editor-section');
                
                if (!this.state.monthlyData) return;
                
                let html = '<table class="data-table"><thead><tr>';
                html += '<th>Theme</th><th>Indicator</th><th>Current Value</th>';
                html += '<th>Freshness</th><th>Source</th><th>Action</th>';
                html += '</tr></thead><tbody>';
                
                Object.entries(this.indicators).forEach(([theme, indicators]) => {
                    Object.entries(indicators).forEach(([key, config]) => {
                        const dataKey = this.getDataKey(theme, key);
                        const value = this.getIndicatorValue(dataKey);
                        const isManual = this.state.manualOverrides[dataKey];
                        
                        html += `<tr class="${isManual ? 'manual-override' : ''}">`;
                        html += `<td>${theme.toUpperCase()}</td>`;
                        html += `<td>${config.name} <span class="tier-badge tier-${config.tier}">${config.tier}</span></td>`;
                        html += `<td>${value !== null ? value.toFixed(2) : 'N/A'}</td>`;
                        html += `<td><span class="status-good">✅ Fresh</span></td>`;
                        html += `<td>${isManual ? 'Manual ✏️' : 'Auto'}</td>`;
                        html += `<td><button class="edit-button" onclick="tracker.openEditModal('${dataKey}')">Edit</button></td>`;
                        html += '</tr>';
                    });
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                section.style.display = 'block';
            },
            
            getDataKey: function(theme, indicator) {
                // Map to data collector keys
                const keyMap = {
                    'usd_dxy': 'dxy',
                    'usd_gold': 'gold',
                    'usd_yuanSwift': 'yuanSwift',
                    'usd_reserveShare': 'reserveShare',
                    'innovation_qqqSpy': 'qqqSpy',
                    'innovation_productivity': 'productivity',
                    'innovation_netMargins': 'netMargins',
                    'pe_riskPremium': 'riskPremium',
                    'pe_forwardPE': 'forwardPE',
                    'pe_cape': 'cape',
                    'international_acwxSpy': 'acwxSpy',
                    'international_spVsWorld': 'spVsWorld',
                    'international_usAcwi': 'usAcwi',
                    'international_ticFlows': 'ticFlows'
                };
                return keyMap[`${theme}_${indicator}`] || indicator;
            },
            
            getIndicatorValue: function(key) {
                if (!this.state.monthlyData || !this.state.monthlyData.indicators) return null;
                
                // Check manual overrides first
                if (this.state.manualOverrides[key]) {
                    return this.state.manualOverrides[key].value;
                }
                
                // Search through theme structure
                for (const theme in this.state.monthlyData.indicators) {
                    if (this.state.monthlyData.indicators[theme][key]) {
                        return this.state.monthlyData.indicators[theme][key].current;
                    }
                }
                return null;
            },
            
            openEditModal: function(indicatorKey) {
                this.editingIndicator = indicatorKey;
                const value = this.getIndicatorValue(indicatorKey);
                
                // Find indicator config
                let config = null;
                for (const [theme, indicators] of Object.entries(this.indicators)) {
                    for (const [key, cfg] of Object.entries(indicators)) {
                        if (this.getDataKey(theme, key) === indicatorKey) {
                            config = cfg;
                            break;
                        }
                    }
                }
                
                document.getElementById('modal-title').textContent = `Edit ${config ? config.name : indicatorKey}`;
                
                const modalBody = document.getElementById('modal-body');
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>Current Value</label>
                        <input type="number" id="edit-current" value="${value || 0}" step="any">
                    </div>
                    <div class="form-group">
                        <label>Historical Values (6 months)</label>
                        <div class="history-grid">
                            ${[5,4,3,2,1,0].map(i => `
                                <input type="number" id="edit-history-${i}" placeholder="Month -${5-i}" step="any">
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.getElementById('edit-modal').classList.add('active');
            },
            
            closeEditModal: function() {
                document.getElementById('edit-modal').classList.remove('active');
                this.editingIndicator = null;
            },
            
            saveIndicatorEdit: function() {
                if (!this.editingIndicator) return;
                
                const newValue = parseFloat(document.getElementById('edit-current').value);
                if (isNaN(newValue)) {
                    alert('Please enter a valid number');
                    return;
                }
                
                // Save to manual overrides
                this.state.manualOverrides[this.editingIndicator] = {
                    value: newValue,
                    timestamp: new Date().toISOString(),
                    history: [0,1,2,3,4,5].map(i => {
                        const val = document.getElementById(`edit-history-${i}`).value;
                        return val ? parseFloat(val) : null;
                    })
                };
                
                // Update display
                this.displayDataTable();
                this.closeEditModal();
                this.saveState();
            },
            
            // Sample Data Generator
            generateSampleData: function() {
                const now = new Date();
                const sampleData = {
                    version: '3.8.0',
                    mode: 'monthly',
                    timestamp: now.toISOString(),
                    trading_status: 'GREEN',
                    indicators: {}
                };
                
                // Generate sample values for each theme
                const themes = {
                    usd: {
                        dxy: { current: 97.5 + Math.random() * 5, history: this.generateHistory(97.5, 5) },
                        gold: { current: 100 + Math.random() * 20, history: this.generateHistory(100, 20) },
                        yuanSwift: { current: 2 + Math.random() * 2, history: this.generateHistory(2, 2) },
                        reserveShare: { current: 58 + Math.random() * 4, history: this.generateHistory(58, 4) }
                    },
                    innovation: {
                        qqqSpy: { current: 0.85 + Math.random() * 0.15, history: this.generateHistory(0.85, 0.15) },
                        productivity: { current: 110 + Math.random() * 10, history: this.generateHistory(110, 10) },
                        netMargins: { current: 10 + Math.random() * 4, history: this.generateHistory(10, 4) }
                    },
                    pe: {
                        riskPremium: { current: -1 + Math.random() * 3, history: this.generateHistory(-1, 3) },
                        forwardPE: { current: 20 + Math.random() * 10, history: this.generateHistory(20, 10) },
                        cape: { current: 30 + Math.random() * 10, history: this.generateHistory(30, 10) }
                    },
                    international: {
                        acwxSpy: { current: 0.95 + Math.random() * 0.1, history: this.generateHistory(0.95, 0.1) },
                        spVsWorld: { current: -2 + Math.random() * 4, history: this.generateHistory(-2, 4) },
                        usAcwi: { current: 58 + Math.random() * 4, history: this.generateHistory(58, 4) },
                        ticFlows: { current: -50 + Math.random() * 200, history: this.generateHistory(-50, 200) }
                    }
                };
                
                sampleData.indicators = themes;
                this.state.monthlyData = sampleData;
                this.state.initializationData = { ...sampleData, mode: 'initialization' };
                
                document.getElementById('init-status').innerHTML = 
                    '<span class="status-warning">⚠️ Using sample initialization data</span>';
                document.getElementById('monthly-status').innerHTML = 
                    '<span class="status-warning">⚠️ Using sample monthly data</span>';
                
                this.checkDataComplete();
                this.calculateThemes();
            },
            
            generateHistory: function(base, range) {
                const history = [];
                for (let i = 0; i < 6; i++) {
                    history.push(base + (Math.random() - 0.5) * range);
                }
                return history;
            },
            
            // Step 3: Theme Analysis
            calculateThemes: function() {
                if (!this.state.monthlyData) return;
                
                const container = document.getElementById('theme-container');
                let html = '';
                
                Object.entries(this.indicators).forEach(([theme, indicators]) => {
                    const probability = this.calculateThemeProbability(theme, indicators);
                    this.state.themeProbabilities[theme] = probability;
                    
                    html += this.renderThemeCard(theme, indicators, probability);
                });
                
                container.innerHTML = html;
                this.calculateScenarios();
            },
            
            calculateThemeProbability: function(theme, indicators) {
                let weightedSum = 0;
                let totalWeight = 0;
                
                Object.entries(indicators).forEach(([key, config]) => {
                    const dataKey = this.getDataKey(theme, key);
                    const value = this.getIndicatorValue(dataKey);
                    const momentum = this.calculateMomentum(dataKey);
                    
                    weightedSum += momentum * config.weight;
                    totalWeight += config.weight;
                });
                
                return totalWeight > 0 ? (weightedSum / totalWeight) * 50 + 50 : 50;
            },
            
            calculateMomentum: function(indicatorKey) {
                // Simplified momentum calculation
                const value = this.getIndicatorValue(indicatorKey);
                if (value === null) return 0;
                
                // For now, return random momentum for demonstration
                return (Math.random() - 0.5) * 2;
            },
            
            renderThemeCard: function(theme, indicators, probability) {
                const themeNames = {
                    usd: 'USD Erosion',
                    innovation: 'AI Productivity Boom',
                    pe: 'P/E Mean Reversion',
                    international: 'International Outperformance'
                };
                
                let html = `
                    <div class="theme-card">
                        <div class="theme-header">
                            <div class="theme-name">${themeNames[theme]}</div>
                            <div class="theme-probability">${probability.toFixed(1)}%</div>
                        </div>
                        <div class="indicator-list">
                `;
                
                Object.entries(indicators).forEach(([key, config]) => {
                    const dataKey = this.getDataKey(theme, key);
                    const value = this.getIndicatorValue(dataKey);
                    const momentum = this.calculateMomentum(dataKey);
                    
                    html += `
                        <div class="indicator-item">
                            <div class="indicator-header">
                                <span class="indicator-name">
                                    ${config.name}
                                    <span class="tier-badge tier-${config.tier}">${config.tier}</span>
                                </span>
                                <span class="indicator-value">${value ? value.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="indicator-bar">
                                <div class="indicator-arrow ${momentum > 0 ? 'arrow-positive' : 'arrow-negative'}" 
                                     style="left: ${50 + momentum * 25}%">
                                    <div class="arrow-body" style="width: ${Math.abs(momentum) * 25}px;"></div>
                                    <div class="arrow-head" style="border-width: 8px;"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                return html;
            },
            
            calculateScenarios: function() {
                // Calculate 16 scenarios based on theme combinations
                const scenarios = [];
                for (let i = 0; i < 16; i++) {
                    const scenario = {
                        usd: (i & 1) > 0,
                        innovation: (i & 2) > 0,
                        pe: (i & 4) > 0,
                        international: (i & 8) > 0,
                        probability: this.calculateScenarioProbability(i)
                    };
                    scenarios.push(scenario);
                }
                
                // Sort by probability
                scenarios.sort((a, b) => b.probability - a.probability);
                this.state.scenarioProbabilities = scenarios;
                
                // Display top scenarios
                const summary = document.getElementById('scenario-summary');
                let html = '<h3>Top Scenarios</h3><div style="display: flex; gap: 15px; flex-wrap: wrap;">';
                
                scenarios.slice(0, 5).forEach(scenario => {
                    const name = [
                        scenario.usd ? 'USD↓' : '',
                        scenario.innovation ? 'AI↑' : '',
                        scenario.pe ? 'P/E↓' : '',
                        scenario.international ? 'INTL↑' : ''
                    ].filter(x => x).join(' + ') || 'Base Case';
                    
                    html += `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${name}</div>
                            <div style="font-size: 1.2em; color: #667eea;">${scenario.probability.toFixed(1)}%</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                summary.innerHTML = html;
                
                if (!this.completedSteps.includes(3)) {
                    this.completedSteps.push(3);
                }
                this.updateStepIndicators();
                this.saveState();
            },
            
            calculateScenarioProbability: function(scenarioIndex) {
                // Calculate probability based on theme probabilities
                const probs = this.state.themeProbabilities;
                let probability = 1;
                
                probability *= (scenarioIndex & 1) ? probs.usd / 100 : (1 - probs.usd / 100);
                probability *= (scenarioIndex & 2) ? probs.innovation / 100 : (1 - probs.innovation / 100);
                probability *= (scenarioIndex & 4) ? probs.pe / 100 : (1 - probs.pe / 100);
                probability *= (scenarioIndex & 8) ? probs.international / 100 : (1 - probs.international / 100);
                
                return probability * 100;
            },
            
            // State Persistence
            saveState: function() {
                const stateData = {
                    version: this.version,
                    currentStep: this.currentStep,
                    completedSteps: this.completedSteps,
                    state: this.state
                };
                localStorage.setItem('hcp-tracker-v631-state', JSON.stringify(stateData));
            },
            
            loadState: function() {
                const saved = localStorage.getItem('hcp-tracker-v631-state');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        if (data.version === this.version) {
                            this.currentStep = data.currentStep || 1;
                            this.completedSteps = data.completedSteps || [];
                            this.state = data.state || this.state;
                            
                            // Restore UI state
                            if (this.state.philosophyAcknowledged) {
                                document.getElementById('philosophy-checkbox').checked = true;
                            }
                            
                            if (this.state.initializationData) {
                                document.getElementById('init-status').innerHTML = 
                                    '<span class="status-good">✅ Initialization data loaded from cache</span>';
                            }
                            
                            if (this.state.monthlyData) {
                                document.getElementById('monthly-status').innerHTML = 
                                    '<span class="status-good">✅ Monthly data loaded from cache</span>';
                                this.checkDataComplete();
                            }
                        }
                    } catch (e) {
                        console.error('Error loading saved state:', e);
                    }
                }
            }
        };
        
        // Initialize on page load
        window.addEventListener('load', function() {
            tracker.init();
        });
    </script>
</body>
</html>