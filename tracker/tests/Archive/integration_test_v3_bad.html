<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCP Portfolio Tracker - Integration Test v3</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
        }
        
        .version-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .test-results {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .test-passed {
            color: #28a745;
            font-weight: bold;
        }
        
        .test-failed {
            color: #dc3545;
            font-weight: bold;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.secondary {
            background: #6c757d;
        }
        
        button.secondary:hover {
            background: #545b62;
        }
        
        .navigation {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .step-indicator {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .step-active {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        
        .step-completed {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
        }
        
        .step-pending {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        .indicator-edit {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Theme Analysis Styling */
        .theme-analysis-v2 {
            margin: 20px 0;
        }
        
        .analysis-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px;
            border-radius: 6px 6px 0 0;
        }
        
        .analysis-meta {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .analysis-summary {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .summary-item {
            background: white;
            padding: 12px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .summary-label {
            display: block;
            font-weight: bold;
            color: #666;
            font-size: 0.9em;
        }
        
        .summary-value {
            display: block;
            font-size: 1.1em;
            margin-top: 4px;
        }
        
        .uncertainty-high { color: #dc3545; }
        .uncertainty-medium { color: #ffc107; }
        .uncertainty-low { color: #28a745; }
        .confidence-high { color: #28a745; }
        .confidence-medium { color: #ffc107; }
        .confidence-low { color: #dc3545; }
        
        .theme-probabilities {
            margin: 20px 0;
        }
        
        .theme-item {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .theme-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .theme-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .theme-percentage {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .confidence-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .theme-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .theme-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .theme-usd { background: #dc3545; }
        .theme-ai { background: #007bff; }
        .theme-pe { background: #ffc107; }
        .theme-intl { background: #28a745; }
        
        .theme-description {
            color: #666;
            font-size: 0.9em;
            font-style: italic;
            margin-top: 8px;
        }
        
        .scenario-matrix {
            margin: 20px 0;
        }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .scenario-item {
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .scenario-very-high { 
            background: #d4edda; 
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .scenario-high { 
            background: #d1ecf1; 
            border-color: #bee5eb;
            color: #0c5460;
        }
        
        .scenario-medium { 
            background: #fff3cd; 
            border-color: #ffeaa7;
            color: #856404;
        }
        
        .scenario-low { 
            background: #f8d7da; 
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .scenario-very-low { 
            background: #e2e3e5; 
            border-color: #d6d8db;
            color: #383d41;
        }
        
        .scenario-rank {
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .scenario-name {
            font-weight: bold;
            margin: 4px 0;
        }
        
        .scenario-probability {
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .scenario-binary {
            font-family: monospace;
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
        }
        
        .validation-status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 6px;
        }
        
        .validation-indicator.valid {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .validation-indicator.invalid {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .validation-issues {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .validation-issues li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>HCP Portfolio Tracker</h1>
        <h2>Integration Test v3.0</h2>
        <p>ThemeCalculator v2.0 - IPS v3.9 Compliant</p>
    </div>
    
    <div class="container">
        <div class="version-info">
            <h3>Module Compatibility Matrix</h3>
            <ul>
                <li><strong>TrackerCore:</strong> v1.0 (navigation, state management)</li>
                <li><strong>DataEditor:</strong> v1.0 (modal editing system)</li>
                <li><strong>Indicators:</strong> v1.0 (13-indicator framework)</li>
                <li><strong>FileHandler:</strong> v1.0 (enhanced sample data)</li>
                <li><strong>ThemeCalculator:</strong> v2.0 (IPS v3.9 methodology)</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>Module Load Tests</h3>
            <button onclick="runModuleTests()">Run Module Tests</button>
            <div id="module-test-results" class="test-results"></div>
        </div>
    </div>
    
    <!-- Step Navigation -->
    <div class="navigation">
        <button onclick="tracker.navigateToStep(1)">Step 1: Philosophy</button>
        <button onclick="tracker.navigateToStep(2)">Step 2: Data</button>
        <button onclick="tracker.navigateToStep(3)">Step 3: Themes</button>
        <button class="secondary" onclick="tracker.exportState()">Export State</button>
        <button class="secondary" onclick="tracker.reset()">Reset</button>
    </div>
    
    <!-- Step Indicators -->
    <div class="container">
        <div id="step-indicators"></div>
    </div>
    
    <!-- Step 1: Philosophy -->
    <div class="container" id="step-1" style="display: none;">
        <h3>Step 1: Investment Philosophy</h3>
        <div class="step-indicator step-active" id="step-1-indicator">
            <label>
                <input type="checkbox" id="philosophy-checkbox" onchange="tracker.handlePhilosophyChange(this.checked)">
                I acknowledge and understand the HCP investment philosophy and methodology
            </label>
        </div>
        <p>This portfolio uses systematic, probability-weighted allocation based on macro regime analysis across 16 scenarios.</p>
    </div>
    
    <!-- Step 2: Data Loading -->
    <div class="container" id="step-2" style="display: none;">
        <h3>Step 2: Data Loading</h3>
        <div class="test-section">
            <button onclick="generateAndLoadSampleData()">Generate Sample Data</button>
            <button onclick="generateAndLoadSampleData('tech_boom')">Load Tech Boom Scenario</button>
            <button onclick="generateAndLoadSampleData('usd_strength')">Load USD Strength Scenario</button>
            <button onclick="generateAndLoadSampleData('pe_reversion')">Load P/E Reversion Scenario</button>
        </div>
        <div id="data-display"></div>
    </div>
    
    <!-- Step 3: Theme Analysis -->
    <div class="container" id="step-3" style="display: none;">
        <h3>Step 3: Theme Analysis</h3>
        <div class="test-section">
            <button onclick="runEnhancedThemeAnalysis()">Run Enhanced Theme Analysis</button>
            <button onclick="testThemeCalculatorV2()">Test ThemeCalculator v2.0</button>
            <button onclick="compareWithV1Results()">Compare with v1.0 Results</button>
        </div>
        <div id="theme-results"></div>
        <div id="theme-comparison"></div>
    </div>
    
    <!-- Load Core Modules -->
    <script src="../core/tracker_core.js"></script>
    <script src="../modules/data_editor_v1_0.js"></script>
    <script src="../modules/indicators_v1_0.js"></script>
    <script src="../modules/file_handler_v1_0.js"></script>
    <script src="../modules/theme_calculator_v2_0.js"></script>
    
    <script>
        // Integration Layer - Connect modules to create unified tracker
        const tracker = {
            // Core functionality from TrackerCore
            ...TrackerCore,
            
            // Override/enhance with module capabilities
            indicators: Indicators.definitions,
            
            // Data editing functions
            openEditModal: DataEditor.openEditModal,
            closeEditModal: DataEditor.closeEditModal,
            saveIndicatorEdit: DataEditor.saveIndicatorEdit,
            
            // File handling
            handleFileUpload: FileHandler.handleFileUpload,
            generateSampleData: FileHandler.generateSampleData,
            
            // Enhanced theme calculation using v2.0
            calculateEnhancedThemes: function() {
                if (!this.state.monthlyData) {
                    alert('Please load data first (Step 2)');
                    return;
                }
                
                console.log('Running enhanced theme analysis with ThemeCalculator v2.0...');
                
                // Use IPS v3.9 compliant calculations
                const analysis = ThemeCalculator.calculateThemeAnalysis(
                    this.state.monthlyData,
                    this.indicators
                );
                
                // Store results in state
                this.state.themeAnalysis = analysis;
                this.state.themeProbabilities = analysis.themes;
                
                // Display results using v2.0 formatting
                ThemeCalculator.displayThemeResults(analysis, 'theme-results');
                
                console.log('Enhanced analysis complete:', analysis);
                
                // Save state
                this.saveState();
            },
            
            // Legacy theme calculation for comparison
            calculateLegacyThemes: function() {
                // Placeholder for v1.0 comparison
                console.log('Legacy theme calculation not available in this test');
            }
        };
        
        // Module Testing Functions
        function testTrackerCore() {
            try {
                const hasNavigate = typeof tracker.navigateToStep === 'function';
                const hasState = typeof tracker.state === 'object';
                const hasSave = typeof tracker.saveState === 'function';
                const hasLoad = typeof tracker.loadState === 'function';
                
                return {
                    name: 'TrackerCore',
                    passed: hasNavigate && hasState && hasSave && hasLoad,
                    message: hasNavigate && hasState && hasSave && hasLoad ? 
                        'All core navigation functions available' : 
                        'Some core functions missing'
                };
            } catch (error) {
                return {
                    name: 'TrackerCore',
                    passed: false,
                    message: 'Error: ' + error.message
                };
            }
        }
        
        function testDataEditor() {
            try {
                const hasOpen = typeof DataEditor.openEditModal === 'function';
                const hasClose = typeof DataEditor.closeEditModal === 'function';
                const hasSave = typeof DataEditor.saveIndicatorEdit === 'function';
                const hasSetup = typeof DataEditor.setupEventListeners === 'function';
                
                return {
                    name: 'DataEditor',
                    passed: hasOpen && hasClose && hasSave && hasSetup,
                    message: hasOpen && hasClose && hasSave && hasSetup ? 
                        'All editing functions available' : 
                        'Some editing functions missing'
                };
            } catch (error) {
                return {
                    name: 'DataEditor',
                    passed: false,
                    message: 'Error: ' + error.message
                };
            }
        }
        
        function testIndicators() {
            try {
                const hasDefinitions = typeof Indicators.definitions === 'object';
                const hasValidation = typeof Indicators.validateIndicatorData === 'function';
                const hasCount = Object.keys(Indicators.definitions || {}).length >= 13;
                
                return {
                    name: 'Indicators',
                    passed: hasDefinitions && hasValidation && hasCount,
                    message: hasDefinitions && hasValidation && hasCount ? 
                        `${Object.keys(Indicators.definitions || {}).length} indicators defined correctly` : 
                        'Indicator definitions incomplete'
                };
            } catch (error) {
                return {
                    name: 'Indicators',
                    passed: false,
                    message: 'Error: ' + error.message
                };
            }
        }
        
        function testFileHandler() {
            try {
                const hasGenerate = typeof FileHandler.generateSampleData === 'function';
                const hasHandle = typeof FileHandler.handleFileUpload === 'function';
                const hasValidate = typeof FileHandler.validateDataStructure === 'function';
                const hasScenarios = typeof FileHandler.generateSampleData === 'function';
                
                return {
                    name: 'FileHandler',
                    passed: hasGenerate && hasHandle && hasValidate && hasScenarios,
                    message: hasGenerate && hasHandle && hasValidate && hasScenarios ? 
                        'All file functions available' : 
                        'Some file functions missing'
                };
            } catch (error) {
                return {
                    name: 'FileHandler',
                    passed: false,
                    message: 'Error: ' + error.message
                };
            }
        }
        
        function testThemeCalculatorV2() {
            try {
                const hasCalculate = typeof ThemeCalculator.calculateThemeAnalysis === 'function';
                const hasDisplay = typeof ThemeCalculator.displayThemeResults === 'function';
                const hasEnhanced = typeof ThemeCalculator.calculateEnhancedTransitionProbability === 'function';
                const hasScenarios = typeof ThemeCalculator.generateScenarios === 'function';
                const hasValidation = typeof ThemeCalculator.validateResults === 'function';
                const hasVersion = ThemeCalculator.version === '2.0';
                const hasFramework = ThemeCalculator.framework === 'IPS v3.9 Appendix H';
                
                return {
                    name: 'ThemeCalculator v2.0',
                    passed: hasCalculate && hasDisplay && hasEnhanced && hasScenarios && hasValidation && hasVersion && hasFramework,
                    message: hasCalculate && hasDisplay && hasEnhanced && hasScenarios && hasValidation && hasVersion && hasFramework ? 
                        'All IPS v3.9 analysis functions available' : 
                        'Some v2.0 functions missing or incorrect version'
                };
            } catch (error) {
                return {
                    name: 'ThemeCalculator v2.0',
                    passed: false,
                    message: 'Error: ' + error.message
                };
            }
        }
        
        function runModuleTests() {
            const tests = [
                testTrackerCore(),
                testDataEditor(),
                testIndicators(),
                testFileHandler(),
                testThemeCalculatorV2()
            ];
            
            const passed = tests.filter(t => t.passed).length;
            const total = tests.length;
            
            let html = `<strong>Test Summary: ${passed}/${total} passed</strong>\n\n`;
            
            tests.forEach(test => {
                const status = test.passed ? '✓ PASSED' : '✗ FAILED';
                const className = test.passed ? 'test-passed' : 'test-failed';
                html += `<span class="${className}">${test.name}: ${status}</span>\n`;
                html += `  ${test.message}\n\n`;
            });
            
            document.getElementById('module-test-results').innerHTML = html;
        }
        
        // Data Generation Functions
        function generateAndLoadSampleData(scenario = 'tech_boom') {
            try {
                console.log(`Generating ${scenario} sample data...`);
                const sampleData = FileHandler.generateSampleData('monthly', scenario);
                
                if (!sampleData) {
                    alert('Failed to generate sample data');
                    return;
                }
                
                tracker.handleDataLoad(sampleData, 'sample');
                displayDataTable(sampleData);
                
                console.log('Sample data loaded successfully');
                
            } catch (error) {
                console.error('Error generating sample data:', error);
                alert('Error generating sample data: ' + error.message);
            }
        }
        
        function displayDataTable(data) {
            if (!data || !data.indicators) {
                document.getElementById('data-display').innerHTML = '<p>No data to display</p>';
                return;
            }
            
            let html = '<h4>Sample Data Generated</h4>';
            html += '<table class="data-table">';
            html += '<tr><th>Theme</th><th>Indicator</th><th>Current Value</th><th>History (6 months)</th><th>Action</th></tr>';
            
            const themes = ['usd', 'ai', 'pe', 'intl'];
            const themeNames = {
                usd: 'USD',
                ai: 'Innovation', 
                pe: 'P/E',
                intl: 'International'
            };
            
            Object.entries(data.indicators).forEach(([key, indicator]) => {
                // Find which theme this indicator belongs to
                let theme = 'unknown';
                for (const themeName of themes) {
                    const themeIndicators = Indicators.definitions[themeName];
                    if (themeIndicators && Object.values(themeIndicators).some(def => def.dataKey === key)) {
                        theme = themeNames[themeName];
                        break;
                    }
                }
                
                const historyStr = indicator.history ? 
                    indicator.history.slice(-6).map(v => v.toFixed(2)).join(', ') : 
                    'No history';
                
                html += `<tr>
                    <td>${theme}</td>
                    <td>${indicator.name || key}</td>
                    <td>${typeof indicator.current === 'number' ? indicator.current.toFixed(2) : indicator.current}</td>
                    <td>${historyStr}</td>
                    <td><button onclick="tracker.openEditModal('${key}', '${indicator.name || key}', ${indicator.current})">Edit</button></td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('data-display').innerHTML = html;
        }
        
        // Theme Analysis Functions
        function runEnhancedThemeAnalysis() {
            if (!tracker.state.monthlyData) {
                alert('Please load data first (Step 2)');
                return;
            }
            
            console.log('Running enhanced theme analysis...');
            tracker.calculateEnhancedThemes();
        }
        
        function compareWithV1Results() {
            if (!tracker.state.themeAnalysis) {
                alert('Please run theme analysis first');
                return;
            }
            
            const comparison = document.getElementById('theme-comparison');
            comparison.innerHTML = `
                <div class="container">
                    <h4>Version Comparison</h4>
                    <div class="version-info">
                        <p><strong>Current Analysis:</strong> ThemeCalculator v2.0 (IPS v3.9 Appendix H)</p>
                        <p><strong>Methodology:</strong> Three-component model with physics-based time estimation</p>
                        <p><strong>Key Improvements:</strong></p>
                        <ul>
                            <li>Distance-to-trigger boundary conditions</li>
                            <li>Direction-based probability adjustments</li>
                            <li>Time-decay probability functions</li>
                            <li>Enhanced momentum calculations</li>
                            <li>Comprehensive validation framework</li>
                        </ul>
                        <p><strong>Expected vs v1.0:</strong> More realistic probability distributions with stronger signals producing higher probabilities (65% momentum should yield 75-85% theme probability instead of ~59%)</p>
                    </div>
                </div>
            `;
        }
        
        // Initialize the tracker
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Integration Test v3.0...');
            
            // Initialize tracker core
            if (typeof TrackerCore.init === 'function') {
                TrackerCore.init();
            }
            
            // Setup data editor event listeners
            if (typeof DataEditor.setupEventListeners === 'function') {
                DataEditor.setupEventListeners();
            }
            
            // Start at step 1
            tracker.navigateToStep(1);
            
            console.log('Integration Test v3.0 initialized successfully');
            console.log('Modules loaded:', {
                TrackerCore: typeof TrackerCore,
                DataEditor: typeof DataEditor,
                Indicators: typeof Indicators,
                FileHandler: typeof FileHandler,
                ThemeCalculator: typeof ThemeCalculator,
                'TC Version': ThemeCalculator.version,
                'TC Framework': ThemeCalculator.framework
            });
        });
    </script>
</body>
</html>